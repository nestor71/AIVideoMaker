<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸŒ Traduzione Video - AIVideoMaker</title>

    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="/static/css/modern-styles.css" rel="stylesheet">
    <link href="/static/css/alerts.css" rel="stylesheet">
</head>
<body>
    <!-- Header -->
    <header class="main-header">
        <div class="container">
            <a href="/" class="logo" style="text-decoration: none; color: inherit; cursor: pointer;">
                <i class="fas fa-video"></i>
                <span>AIVideoMaker</span>
            </a>

            <nav class="header-nav">
                <a href="/" class="nav-link">
                    <i class="fas fa-home"></i>
                    <span>Home</span>
                </a>
                <a href="/translation" class="nav-link active">
                    <i class="fas fa-language"></i>
                    <span>Traduzione Video</span>
                </a>
            </nav>
        </div>
    </header>

    <!-- Main Content -->
    <main class="main-content">
        <div class="container">
            <!-- Hero Section -->
            <div class="hero-section">
                <h1><i class="fas fa-language"></i> Traduzione Video AI</h1>
                <p>Traduci i tuoi video in oltre 50 lingue con sintesi vocale e lip-sync opzionale</p>
            </div>

            <!-- Upload Section -->
            <div class="upload-section" style="margin-bottom: 30px;">
                <div class="main-upload-card">
                    <h3><i class="fas fa-video"></i> Video da Tradurre</h3>
                    <div class="upload-area-advanced" id="translationVideoUpload">
                        <div class="upload-content">
                            <i class="fas fa-video upload-icon"></i>
                            <button class="upload-btn" onclick="document.getElementById('translationVideoFile').click()">
                                <i class="fas fa-upload"></i> Carica Video
                            </button>
                        </div>
                        <div class="upload-preview" id="translationVideoPreview" style="display: none;">
                            <video controls class="preview-video-overlay"></video>
                            <button class="preview-remove-btn" onclick="removeTranslationVideo(event)">
                                <i class="fas fa-trash-alt"></i>
                            </button>
                        </div>
                    </div>
                    <input type="file" id="translationVideoFile" accept="video/*" style="display: none;">
                    <div class="file-info" id="translationVideoInfo" style="display: none;">
                        <i class="fas fa-check-circle"></i>
                        <span id="translationVideoName"></span>
                    </div>
                </div>
            </div>

            <!-- Translation Settings -->
            <div class="settings-section" style="background: white; padding: 30px; border-radius: 15px; box-shadow: 0 4px 20px rgba(0,0,0,0.1); margin-bottom: 30px;">
                <h2><i class="fas fa-cog"></i> Impostazioni Traduzione</h2>

                <div class="settings-grid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; margin-top: 20px;">
                    <!-- Lingua Sorgente -->
                    <div class="control-group">
                        <label style="color: #333;"><i class="fas fa-globe"></i> Lingua Sorgente (Auto-detect)</label>
                        <select id="sourceLang" class="form-control" style="color: #333;">
                            <option value="auto">ğŸŒ Rilevamento Automatico</option>
                            <option value="it">ğŸ‡®ğŸ‡¹ Italiano</option>
                            <option value="en">ğŸ‡¬ğŸ‡§ Inglese</option>
                            <option value="es">ğŸ‡ªğŸ‡¸ Spagnolo</option>
                            <option value="fr">ğŸ‡«ğŸ‡· Francese</option>
                            <option value="de">ğŸ‡©ğŸ‡ª Tedesco</option>
                            <option value="pt">ğŸ‡µğŸ‡¹ Portoghese</option>
                        </select>
                    </div>

                    <!-- Lingua Destinazione -->
                    <div class="control-group">
                        <label style="color: #333;"><i class="fas fa-language"></i> Lingua Destinazione *</label>
                        <select id="targetLang" class="form-control" required style="color: #333;">
                            <option value="">Seleziona lingua...</option>
                            <option value="it">ğŸ‡®ğŸ‡¹ Italiano</option>
                            <option value="en">ğŸ‡¬ğŸ‡§ Inglese</option>
                            <option value="es">ğŸ‡ªğŸ‡¸ Spagnolo</option>
                            <option value="fr">ğŸ‡«ğŸ‡· Francese</option>
                            <option value="de">ğŸ‡©ğŸ‡ª Tedesco</option>
                            <option value="pt">ğŸ‡µğŸ‡¹ Portoghese</option>
                            <option value="ru">ğŸ‡·ğŸ‡º Russo</option>
                            <option value="ja">ğŸ‡¯ğŸ‡µ Giapponese</option>
                            <option value="zh-CN">ğŸ‡¨ğŸ‡³ Cinese (Semplificato)</option>
                            <option value="ar">ğŸ‡¸ğŸ‡¦ Arabo</option>
                            <option value="hi">ğŸ‡®ğŸ‡³ Hindi</option>
                            <option value="nl">ğŸ‡³ğŸ‡± Olandese</option>
                            <option value="ko">ğŸ‡°ğŸ‡· Coreano</option>
                            <option value="tr">ğŸ‡¹ğŸ‡· Turco</option>
                            <option value="pl">ğŸ‡µğŸ‡± Polacco</option>
                        </select>
                    </div>
                </div>

                <!-- Opzioni Avanzate -->
                <div style="margin-top: 25px;">
                    <h3 style="margin-bottom: 15px;"><i class="fas fa-sliders-h"></i> Opzioni Avanzate</h3>

                    <div class="toggle-item" style="background: #f8f9fa; padding: 15px; border-radius: 10px; margin-bottom: 10px; display: flex; align-items: flex-start; gap: 15px;">
                        <label class="toggle">
                            <input type="checkbox" id="enableLipsync">
                            <span class="slider"></span>
                        </label>
                        <div>
                            <strong style="color: #333; font-size: 1rem;">Lip-sync AI</strong>
                            <p style="margin: 5px 0 0 0; color: #6c757d; font-size: 0.9rem;">
                                Sincronizza il movimento delle labbra con l'audio tradotto (richiede piÃ¹ tempo)
                            </p>
                        </div>
                    </div>

                    <div class="toggle-item" style="background: #f8f9fa; padding: 15px; border-radius: 10px; display: flex; align-items: flex-start; gap: 15px;">
                        <label class="toggle">
                            <input type="checkbox" id="keepOriginalAudio" checked>
                            <span class="slider"></span>
                        </label>
                        <div>
                            <strong style="color: #333; font-size: 1rem;">Mantieni Audio Originale</strong>
                            <p style="margin: 5px 0 0 0; color: #6c757d; font-size: 0.9rem;">
                                Aggiungi la voce tradotta come sottofondo mantenendo l'audio originale
                            </p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Progress -->
            <div id="translationProgress" style="display: none; margin-bottom: 30px;">
                <div style="background: white; padding: 25px; border-radius: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.1);">
                    <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 15px;">
                        <div class="loading" style="display: inline-block; width: 20px; height: 20px; border: 3px solid rgba(102, 126, 234, 0.3); border-radius: 50%; border-top-color: #667eea; animation: spin 1s ease-in-out infinite;"></div>
                        <span id="translationStatus" style="color: #667eea; font-weight: 600;">Traduzione in corso...</span>
                    </div>
                    <div style="width: 100%; height: 8px; background: #e0e0e0; border-radius: 5px; overflow: hidden;">
                        <div id="translationProgressBar" style="width: 0%; height: 100%; background: linear-gradient(90deg, #667eea, #764ba2); transition: width 0.3s;"></div>
                    </div>
                    <p id="translationProgressText" style="margin-top: 10px; color: #6c757d; font-size: 0.9rem;"></p>
                </div>
            </div>

            <!-- Results -->
            <div id="translationResults" style="display: none; margin-bottom: 30px;">
                <div style="background: white; padding: 25px; border-radius: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.1);">
                    <h3 style="color: #667eea; margin-bottom: 20px;">
                        <i class="fas fa-check-circle"></i> Traduzione Completata!
                    </h3>
                    <div style="display: flex; gap: 15px; margin-top: 20px;">
                        <button class="btn-success" onclick="downloadTranslatedVideo()">
                            <i class="fas fa-download"></i> Scarica Video Tradotto
                        </button>
                        <button class="btn-secondary" onclick="resetTranslation()">
                            <i class="fas fa-redo"></i> Nuova Traduzione
                        </button>
                    </div>
                </div>
            </div>

            <!-- Action Button -->
            <div style="text-align: center;">
                <button class="btn-primary" id="btnStartTranslation" onclick="startTranslation()" disabled style="padding: 18px 50px; font-size: 1.1rem;">
                    <i class="fas fa-language"></i> Avvia Traduzione
                </button>
            </div>
        </div>
    </main>

    <script>
        let translationVideoId = null;
        let translationJobId = null;
        let pollingInterval = null;

        // File upload handler
        document.getElementById('translationVideoFile').addEventListener('change', async function(e) {
            const file = e.target.files[0];
            if (!file) return;

            const formData = new FormData();
            formData.append('file', file);

            try {
                const response = await fetch('/api/upload', {
                    method: 'POST',
                    body: formData
                });

                if (!response.ok) throw new Error('Upload fallito');

                const data = await response.json();
                translationVideoId = data.file_id;

                // Show preview
                document.getElementById('translationVideoInfo').style.display = 'flex';
                document.getElementById('translationVideoName').textContent = file.name;

                const preview = document.getElementById('translationVideoPreview');
                const video = preview.querySelector('video');
                video.src = URL.createObjectURL(file);
                preview.style.display = 'flex';

                document.getElementById('translationVideoUpload').querySelector('.upload-content').style.display = 'none';

                // Enable button
                document.getElementById('btnStartTranslation').disabled = false;

                showAlert('Video caricato con successo!', 'success');
            } catch (error) {
                console.error('Errore upload:', error);
                showAlert('Errore durante l\'upload del video', 'error');
            }
        });

        function removeTranslationVideo(e) {
            e.stopPropagation();
            translationVideoId = null;
            document.getElementById('translationVideoFile').value = '';
            document.getElementById('translationVideoInfo').style.display = 'none';
            document.getElementById('translationVideoPreview').style.display = 'none';
            document.getElementById('translationVideoUpload').querySelector('.upload-content').style.display = 'flex';
            document.getElementById('btnStartTranslation').disabled = true;
        }

        async function startTranslation() {
            if (!translationVideoId) {
                showAlert('Carica prima un video', 'warning');
                return;
            }

            const targetLang = document.getElementById('targetLang').value;
            if (!targetLang) {
                showAlert('Seleziona la lingua di destinazione', 'warning');
                return;
            }

            const formData = new FormData();
            formData.append('video_file_id', translationVideoId);
            formData.append('target_language', targetLang);
            formData.append('source_language', document.getElementById('sourceLang').value);
            formData.append('enable_lipsync', document.getElementById('enableLipsync').checked);
            formData.append('keep_original_audio', document.getElementById('keepOriginalAudio').checked);

            try {
                document.getElementById('translationProgress').style.display = 'block';
                document.getElementById('translationStatus').textContent = 'Avvio traduzione...';
                document.getElementById('btnStartTranslation').disabled = true;

                const response = await fetch('/api/translation/translate-video', {
                    method: 'POST',
                    body: formData
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.detail || 'Errore durante l\'avvio della traduzione');
                }

                const result = await response.json();
                translationJobId = result.job_id;

                // Start polling
                startPolling();

            } catch (error) {
                console.error('Errore:', error);
                showAlert(error.message, 'error');
                document.getElementById('translationProgress').style.display = 'none';
                document.getElementById('btnStartTranslation').disabled = false;
            }
        }

        function startPolling() {
            pollingInterval = setInterval(async () => {
                try {
                    const response = await fetch(`/api/job/${translationJobId}`);
                    const job = await response.json();

                    document.getElementById('translationProgressBar').style.width = job.progress + '%';
                    document.getElementById('translationStatus').textContent = job.message || 'Elaborazione...';
                    document.getElementById('translationProgressText').textContent = `Progresso: ${job.progress}%`;

                    if (job.status === 'completed') {
                        clearInterval(pollingInterval);
                        document.getElementById('translationProgress').style.display = 'none';
                        document.getElementById('translationResults').style.display = 'block';
                        showAlert('Traduzione completata!', 'success');
                    } else if (job.status === 'error') {
                        clearInterval(pollingInterval);
                        throw new Error(job.error || 'Errore durante la traduzione');
                    }
                } catch (error) {
                    clearInterval(pollingInterval);
                    console.error('Errore polling:', error);
                    showAlert(error.message, 'error');
                    document.getElementById('translationProgress').style.display = 'none';
                    document.getElementById('btnStartTranslation').disabled = false;
                }
            }, 2000);
        }

        function downloadTranslatedVideo() {
            if (translationJobId) {
                window.location.href = `/api/download/${translationJobId}`;
            }
        }

        function resetTranslation() {
            translationJobId = null;
            document.getElementById('translationResults').style.display = 'none';
            document.getElementById('translationProgress').style.display = 'none';
            document.getElementById('btnStartTranslation').disabled = false;
            document.getElementById('translationProgressBar').style.width = '0%';
        }

        function showAlert(message, type) {
            // Simple alert implementation
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${type}`;
            alertDiv.textContent = message;
            alertDiv.style.cssText = 'position: fixed; top: 20px; right: 20px; padding: 15px 25px; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.2); z-index: 9999; animation: slideIn 0.3s ease;';

            if (type === 'success') alertDiv.style.background = '#10b981';
            else if (type === 'error') alertDiv.style.background = '#ef4444';
            else if (type === 'warning') alertDiv.style.background = '#f59e0b';

            alertDiv.style.color = 'white';

            document.body.appendChild(alertDiv);

            setTimeout(() => {
                alertDiv.remove();
            }, 3000);
        }
    </script>
</body>
</html>

<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üé¨ AIVideoMaker</title>
    
    <!-- External Dependencies -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    
    <!-- Custom Styles -->
    <link href="/static/css/modern-styles.css" rel="stylesheet">
    <link href="/static/css/alerts.css" rel="stylesheet">
    <link href="/static/css/metadata.css" rel="stylesheet">

    <!-- Recorder Styles -->
    <style>
        .recorder-container {
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
        }

        .recorder-header {
            text-align: center;
            margin-bottom: 30px;
        }

        .recorder-header h2 {
            margin: 0 0 10px 0;
        }

        .recorder-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            border-bottom: 2px solid #e0e0e0;
        }

        .recorder-tab-btn {
            background: none;
            border: none;
            padding: 12px 24px;
            font-size: 1rem;
            cursor: pointer;
            border-bottom: 3px solid transparent;
            transition: all 0.3s;
            color: #6c757d;
        }

        .recorder-tab-btn:hover {
            color: #667eea;
        }

        .recorder-tab-btn.active {
            color: #667eea;
            border-bottom-color: #667eea;
        }

        .recorder-tab-content {
            display: none;
        }

        .recorder-tab-content.active {
            display: block;
        }

        .recording-indicator {
            display: none;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 15px;
            margin: 20px 0;
            align-items: center;
            gap: 20px;
        }

        .recording-indicator.active {
            display: flex;
        }

        .rec-dot {
            width: 20px;
            height: 20px;
            background: #ff0000;
            border-radius: 50%;
            animation: pulse 1.5s ease-in-out infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.6; transform: scale(1.1); }
        }

        .status-info {
            flex: 1;
        }

        .status-info h3 {
            margin: 0 0 5px 0;
        }

        .status-info p {
            margin: 0;
            font-size: 1.1rem;
        }

        .controls {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }

        .control-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .control-group label {
            font-weight: 600;
            color: #333;
        }

        .control-group select {
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 1rem;
            background: white;
            cursor: pointer;
            transition: border-color 0.3s;
        }

        .control-group select:hover {
            border-color: #667eea;
        }

        .control-group select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .recordings-list {
            max-height: 600px;
            overflow-y: auto;
        }
    </style>
</head>
<body>
    <!-- Header -->
    <header class="main-header">
        <div class="container">
            <a href="/" class="logo" style="text-decoration: none; color: inherit; cursor: pointer;">
                <i class="fas fa-video"></i>
                <span>AIVideoMaker</span>
            </a>

            <!-- Navigation Menu -->
            <nav class="header-nav">
                <a href="/" class="nav-link active">
                    <i class="fas fa-home"></i>
                    <span>Home</span>
                </a>
                <a href="#" class="nav-link" onclick="showTab('settings'); return false;">
                    <i class="fas fa-cog"></i>
                    <span>Impostazioni</span>
                </a>
            </nav>

            <div class="hamburger" onclick="toggleSidebar()">
                <span></span>
                <span></span>
                <span></span>
            </div>
        </div>
    </header>

    <!-- Sidebar -->
    <div class="sidebar" id="sidebar">
        <div class="sidebar-content">
            <div class="sidebar-header">
                <h3>Menu</h3>
                <button class="close-btn" onclick="toggleSidebar()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <nav class="sidebar-nav">
                <a href="#" onclick="showSection('upload')"><i class="fas fa-upload"></i> Carica Video</a>
                <a href="#" onclick="showSection('settings')"><i class="fas fa-cog"></i> Impostazioni</a>
                <a href="#" onclick="showSection('quality')"><i class="fas fa-video"></i> Qualit√†</a>
                <a href="#" onclick="newProject()"><i class="fas fa-plus"></i> Nuovo Progetto</a>
                <a href="#" onclick="showHelp()"><i class="fas fa-question-circle"></i> Aiuto</a>
            </nav>
        </div>
    </div>

    <!-- Main Content -->
    <main class="main-content">
        <div class="container">
            <!-- Hero Section -->
            <div class="hero-section">
                <h1>AIVideoMaker</h1>
                <p>Editing video e automazione YouTube basati sull'AI</p>
            </div>

            <!-- Tab Navigation -->
            <div class="tab-navigation">
                <button class="tab-btn active" onclick="showTab('upload')">
                    <i class="fas fa-upload"></i> Caricamento Video
                </button>
                <button class="tab-btn" onclick="showTab('recorder')">
                    <i class="fas fa-record-vinyl"></i> Registrazione
                </button>
                <button class="tab-btn" onclick="showTab('transcription')">
                    <i class="fas fa-closed-captioning"></i> Trascrizione
                </button>
                <button class="tab-btn" onclick="showTab('logo')">
                    <i class="fas fa-image"></i> Logo e CTA
                </button>
                <button class="tab-btn" onclick="showTab('cover')">
                    <i class="fas fa-photo-video"></i> Copertina
                </button>
                <button class="tab-btn" onclick="showTab('metadata')">
                    <i class="fas fa-tags"></i> Metadati
                </button>
                <button class="tab-btn" onclick="showTab('audio')">
                    <i class="fas fa-volume-up"></i> Traduzione Audio
                </button>
                <button class="tab-btn" onclick="showTab('files')">
                    <i class="fas fa-folder-open"></i> File Manager
                </button>
                <button class="tab-btn" onclick="showTab('youtube')">
                    <i class="fab fa-youtube"></i> YouTube
                </button>
            </div>

            <!-- Tab Content -->
            <div class="tab-content">
                <!-- Upload Tab -->
                <div class="tab-pane active" id="uploadTab">
                    <div class="upload-section">
                        <!-- Web Video Download Section (MOVED TO TOP) -->
                        <div class="web-download-section" style="margin-bottom: 30px;">
                            <h3 style="color: #667eea; margin-bottom: 20px;">
                                <i class="fas fa-globe"></i> Scarica Video dal Web
                            </h3>
                            <div style="background: white; padding: 25px; border-radius: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.1);">
                                <div style="display: flex; gap: 10px; margin-bottom: 15px;">
                                    <input type="text"
                                           id="webVideoUrl"
                                           placeholder="Inserisci URL del video (YouTube, Vimeo, link diretto MP4...)"
                                           style="flex: 1; padding: 15px; border: 2px solid #e0e0e0; border-radius: 10px; font-size: 1rem; transition: border-color 0.3s;"
                                           onfocus="this.style.borderColor='#667eea'"
                                           onblur="this.style.borderColor='#e0e0e0'">
                                    <button class="btn-primary" onclick="downloadWebVideo()" style="white-space: nowrap;">
                                        <i class="fas fa-download"></i> Scarica
                                    </button>
                                </div>
                                <div style="display: flex; align-items: center; gap: 10px; color: #6c757d; font-size: 0.9rem;">
                                    <i class="fas fa-info-circle"></i>
                                    <span>Supporta YouTube, Vimeo e link diretti a file video (MP4, MKV, AVI...)</span>
                                </div>

                                <!-- Progress indicator -->
                                <div id="webDownloadProgress" style="display: none; margin-top: 20px;">
                                    <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px;">
                                        <div class="loading" style="display: inline-block; width: 20px; height: 20px; border: 3px solid rgba(102, 126, 234, 0.3); border-radius: 50%; border-top-color: #667eea; animation: spin 1s ease-in-out infinite;"></div>
                                        <span id="webDownloadStatus" style="color: #667eea; font-weight: 600;">Download in corso...</span>
                                    </div>
                                    <div style="width: 100%; height: 8px; background: #e0e0e0; border-radius: 5px; overflow: hidden;">
                                        <div id="webDownloadBar" style="width: 0%; height: 100%; background: linear-gradient(90deg, #667eea, #764ba2); transition: width 0.3s;"></div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Main Video Upload -->
                        <div class="main-upload-card">
                            <h3>Carica Video Principale</h3>
                            <div class="upload-area-advanced" id="mainVideoUpload">
                                <div class="upload-content">
                                    <i class="fas fa-video upload-icon"></i>
                                    <button class="upload-btn" onclick="document.getElementById('mainVideoFile').click()">
                                        <i class="fas fa-upload"></i> Carica
                                    </button>
                                </div>
                                <div class="upload-preview" id="mainVideoPreviewOverlay">
                                    <video controls class="preview-video-overlay">
                                        Your browser does not support the video tag.
                                    </video>
                                    <button class="preview-remove-btn" onclick="removeFile('background', event)" title="Elimina video">
                                        <i class="fas fa-trash-alt"></i>
                                    </button>
                                </div>
                            </div>
                            <input type="file" id="mainVideoFile" class="file-input" accept="video/*">
                            <div class="file-info" id="mainVideoInfo">
                                <div class="file-name-section">
                                    <i class="fas fa-video"></i> <span id="mainVideoName"></span>
                                </div>
                            </div>
                            <div class="file-preview" id="mainVideoPreview">
                                <video controls class="preview-video">
                                    Your browser does not support the video tag.
                                </video>
                                <div style="margin-top: 15px; display: flex; gap: 10px; justify-content: center;">
                                    <button class="btn-secondary" id="downloadMainVideoBtn" onclick="downloadMainVideoToPC()" style="display: none;">
                                        <i class="fas fa-download"></i> Scarica sul PC
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Logo & CTA Tab -->
                <div class="tab-pane" id="logoTab">
                    <div class="logo-cta-section">
                        <!-- Main Video Section - Full Width Top -->
                        <div class="main-video-section">
                            <div class="logo-cta-card">
                                <h3 class="section-title">Video Principale</h3>
                                <div class="upload-area-advanced" id="logoTabMainVideoUpload">
                                    <div class="upload-content">
                                        <i class="fas fa-video upload-icon"></i>
                                        <button class="upload-btn" onclick="document.getElementById('logoTabMainVideoFile').click()">
                                            <i class="fas fa-upload"></i> Carica
                                        </button>
                                    </div>
                                    <div class="upload-preview" id="logoTabMainVideoPreviewOverlay">
                                        <video controls class="preview-video-overlay">
                                            Your browser does not support the video tag.
                                        </video>
                                        <button class="preview-remove-btn" onclick="removeFile('background', event)" title="Elimina video">
                                            <i class="fas fa-trash-alt"></i>
                                        </button>
                                    </div>
                                </div>
                                <input type="file" id="logoTabMainVideoFile" class="file-input" accept="video/*">
                            </div>
                        </div>

                        <!-- Interactive Preview Canvas -->
                        <div class="interactive-preview-section" id="interactivePreviewSection" style="display: none;">
                            <div class="logo-cta-card">
                                <h3 class="section-title">
                                    <i class="fas fa-expand-arrows-alt"></i> Anteprima Interattiva
                                    <span style="font-size: 0.85rem; color: #888; font-weight: normal; margin-left: 10px;">
                                        Trascina e ridimensiona gli elementi
                                    </span>
                                </h3>

                                <div class="preview-canvas-container">
                                    <canvas id="previewCanvas" class="preview-canvas"></canvas>

                                    <!-- Draggable Logo Element -->
                                    <div class="draggable-element logo-element" id="draggableLogo" style="display: none;">
                                        <img id="logoPreviewImage" alt="Logo">
                                        <div class="resize-handles">
                                            <div class="resize-handle nw"></div>
                                            <div class="resize-handle ne"></div>
                                            <div class="resize-handle sw"></div>
                                            <div class="resize-handle se"></div>
                                        </div>
                                        <div class="element-label">Logo</div>
                                    </div>

                                    <!-- Draggable CTA Element -->
                                    <div class="draggable-element cta-element" id="draggableCTA" style="display: none;">
                                        <video id="ctaPreviewVideo" muted loop>
                                            <source type="video/mp4">
                                        </video>
                                        <div class="resize-handles">
                                            <div class="resize-handle nw"></div>
                                            <div class="resize-handle ne"></div>
                                            <div class="resize-handle sw"></div>
                                            <div class="resize-handle se"></div>
                                        </div>
                                        <div class="element-label">CTA Video</div>
                                    </div>
                                </div>

                                <div class="preview-controls">
                                    <div class="preview-info">
                                        <i class="fas fa-info-circle"></i>
                                        <span>Clicca e trascina gli elementi per posizionarli. Usa le maniglie agli angoli per ridimensionare.</span>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Logo & CTA Grid - Bottom Row -->
                        <div class="logo-cta-grid">
                            <!-- Logo Section -->
                            <div class="logo-cta-card">
                                <h3 class="section-title">Carica Logo</h3>
                                <div class="upload-area-advanced" id="logoAdvancedUpload">
                                    <div class="upload-content">
                                        <i class="fas fa-image upload-icon"></i>
                                        <button class="upload-btn" onclick="document.getElementById('logoAdvancedFile').click()">
                                            <i class="fas fa-upload"></i> Carica
                                        </button>
                                    </div>
                                    <div class="upload-preview" id="logoAdvancedPreviewOverlay">
                                        <img class="preview-image-overlay" alt="Logo preview">
                                        <button class="preview-remove-btn" onclick="removeFile('logo', event)" title="Elimina logo">
                                            <i class="fas fa-trash-alt"></i>
                                        </button>
                                    </div>
                                </div>
                                <input type="file" id="logoAdvancedFile" class="file-input" accept="image/*">

                                <!-- Logo Controls -->
                                <div class="controls-section">
                                    <!-- Advanced Controls (Collapsible) -->
                                    <div class="advanced-controls-header" onclick="toggleAdvancedControls('logo')">
                                        <span><i class="fas fa-sliders-h"></i> Controlli Avanzati Posizione e Dimensione</span>
                                        <i class="fas fa-chevron-down toggle-icon" id="logoAdvancedToggle"></i>
                                    </div>

                                    <div class="advanced-controls-content collapsed" id="logoAdvancedControls">
                                        <div class="control-group">
                                            <label>Posizione</label>
                                            <select class="position-select" id="logoPosition">
                                                <option value="top-left">Alto Sinistra</option>
                                                <option value="top-right" selected>Alto Destra</option>
                                                <option value="top-center">Alto Centro</option>
                                                <option value="center">Centro</option>
                                                <option value="bottom-left">Basso Sinistra</option>
                                                <option value="bottom-right">Basso Destra</option>
                                                <option value="bottom-center">Basso Centro</option>
                                            </select>
                                        </div>

                                        <div class="control-group">
                                            <label>Dimensione</label>
                                            <div class="slider-container">
                                                <input type="range" class="dimension-slider" id="logoSize" min="5" max="50" value="10" oninput="updateSliderValue('logoSize', this.value + '%')">
                                                <span class="slider-value" id="logoSizeValue">10%</span>
                                            </div>
                                        </div>

                                        <div class="advanced-controls-note">
                                            <i class="fas fa-info-circle"></i>
                                            Puoi usare il drag-and-drop nell'anteprima o questi controlli per precisione
                                        </div>
                                    </div>

                                    <div class="timing-controls">
                                        <div class="timing-group">
                                            <div class="timing-input">
                                                <label>Tempo Inizio</label>
                                                <input type="number" class="time-input" id="logoStartTime" value="0" min="0">
                                            </div>
                                            <div class="timing-input">
                                                <label>Tempo Fine</label>
                                                <input type="text" class="time-input placeholder-input" id="logoEndTime" placeholder="Lascia vuoto per l'intero video">
                                            </div>
                                        </div>
                                        <div class="timing-note">
                                            Vuoto = durata completa video
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Call to Action Section -->
                            <div class="logo-cta-card">
                                <h3 class="section-title">Carica Call to Action</h3>
                                <div class="upload-area-advanced" id="ctaAdvancedUpload">
                                    <div class="upload-content">
                                        <i class="fas fa-play upload-icon"></i>
                                        <button class="upload-btn" onclick="document.getElementById('ctaAdvancedFile').click()">
                                            <i class="fas fa-upload"></i> Carica
                                        </button>
                                    </div>
                                    <div class="upload-preview" id="ctaAdvancedPreviewOverlay">
                                        <video controls class="preview-video-overlay">
                                            Your browser does not support the video tag.
                                        </video>
                                        <button class="preview-remove-btn" onclick="removeFile('foreground', event)" title="Elimina CTA">
                                            <i class="fas fa-trash-alt"></i>
                                        </button>
                                    </div>
                                </div>
                                <input type="file" id="ctaAdvancedFile" class="file-input" accept="video/*">

                                <!-- CTA Controls -->
                                <div class="controls-section">
                                    <!-- Advanced Controls (Collapsible) -->
                                    <div class="advanced-controls-header" onclick="toggleAdvancedControls('cta')">
                                        <span><i class="fas fa-sliders-h"></i> Controlli Avanzati Posizione e Dimensione</span>
                                        <i class="fas fa-chevron-down toggle-icon" id="ctaAdvancedToggle"></i>
                                    </div>

                                    <div class="advanced-controls-content collapsed" id="ctaAdvancedControls">
                                        <div class="control-group">
                                            <label>Posizione</label>
                                            <select class="position-select" id="ctaPosition">
                                                <option value="top-left">Alto Sinistra</option>
                                                <option value="top-right">Alto Destra</option>
                                                <option value="top-center">Alto Centro</option>
                                                <option value="center" selected>Centro</option>
                                                <option value="bottom-left">Basso Sinistra</option>
                                                <option value="bottom-right">Basso Destra</option>
                                                <option value="bottom-center">Basso Centro</option>
                                            </select>
                                        </div>

                                        <div class="control-group">
                                            <label>Dimensione</label>
                                            <div class="slider-container">
                                                <input type="range" class="dimension-slider" id="ctaSize" min="10" max="100" value="20" oninput="updateSliderValue('ctaSize', this.value + '%')">
                                                <span class="slider-value" id="ctaSizeValue">20%</span>
                                            </div>
                                        </div>

                                        <div class="advanced-controls-note">
                                            <i class="fas fa-info-circle"></i>
                                            Puoi usare il drag-and-drop nell'anteprima o questi controlli per precisione
                                        </div>
                                    </div>

                                    <div class="timing-controls">
                                        <div class="timing-group">
                                            <div class="timing-input">
                                                <label>Tempo Inizio</label>
                                                <input type="number" class="time-input" id="ctaStartTime" value="5" min="0">
                                            </div>
                                            <div class="timing-input">
                                                <label>Tempo Fine</label>
                                                <input type="text" class="time-input placeholder-input" id="ctaEndTime" placeholder="Lascia vuoto per l'intero video">
                                            </div>
                                        </div>
                                        <div class="timing-note">
                                            Se vuoto, il video CTA viene riprodotto completamente senza essere troncato
                                        </div>
                                    </div>
                                    
                                    <!-- Chromakey Section -->
                                    <div class="chromakey-section">
                                        <div class="chromakey-toggle">
                                            <label class="toggle toggle-green">
                                                <input type="checkbox" id="chromakeyEnabled" checked>
                                                <span class="slider"></span>
                                            </label>
                                            <span>Rimuovi Sfondo Verde/Blu</span>
                                        </div>
                                        
                                        <div class="chromakey-controls" id="chromakeyControls">
                                            <label>Colore Sfondo da Rimuovere</label>
                                            <div class="color-picker-grid">
                                                <div class="color-option active" data-color="green">
                                                    <div class="color-swatch green"></div>
                                                </div>
                                                <div class="color-option" data-color="blue">
                                                    <div class="color-swatch blue"></div>
                                                </div>
                                            </div>
                                            
                                            <div class="chromakey-info">
                                                <i class="fas fa-info-circle"></i>
                                                La rimozione dello sfondo verr√† applicata automaticamente. Il sistema rilever√† automaticamente il colore ottimale oppure puoi scegliere un preset.
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Apply Overlay Button -->
                        <div class="apply-overlay-section">
                            <button class="apply-overlay-btn" id="applyOverlayBtn" onclick="applyOverlayDirectly()">
                                <i class="fas fa-layer-group"></i>
                                <span>Applica Sovrapposizione</span>
                            </button>
                        </div>
                    </div>
                </div>

                <div class="tab-pane" id="coverTab">
                    <div class="card">
                        <div class="card-header">
                            <h2><i class="fas fa-image"></i> Generatore Miniatura YouTube AI</h2>
                            <p>Crea miniature accattivanti per aumentare visualizzazioni e click</p>
                        </div>

                        <div class="card-body">
                            <!-- Upload Video Section -->
                            <div class="upload-section">
                                <h3><i class="fas fa-video"></i> 1. Carica il tuo video</h3>
                                <div class="upload-area-advanced" id="coverVideoDropZone">
                                    <div class="upload-content">
                                        <i class="fas fa-video upload-icon"></i>
                                        <button class="upload-btn" onclick="document.getElementById('coverVideoInput').click()">
                                            <i class="fas fa-upload"></i> Carica
                                        </button>
                                    </div>
                                    <input type="file" id="coverVideoInput" accept="video/*" style="display: none;">
                                </div>
                                <div id="coverVideoPreview" class="file-preview" style="display: none; margin-top: 20px;">
                                    <div style="position: relative;">
                                        <video id="coverVideoElement" controls style="width: 100%; max-height: 400px; border-radius: 8px; display: block !important; background: #000;">
                                            Il tuo browser non supporta il tag video.
                                        </video>
                                        <button class="video-remove-btn" onclick="removeCoverVideo()" title="Rimuovi video">
                                            <i class="fas fa-trash-alt"></i>
                                        </button>
                                    </div>
                                    <div class="file-info" style="margin-top: 10px; display: flex; align-items: center; gap: 10px; padding: 10px; background: #f8fafc; border-radius: 8px;">
                                        <i class="fas fa-video" style="color: #667eea; font-size: 1.2rem;"></i>
                                        <span id="coverVideoName" style="font-weight: 600; color: #1e293b; font-size: 0.9rem;"></span>
                                    </div>
                                </div>
                            </div>

                            <!-- Image Source Selection -->
                            <div class="options-section">
                                <h3><i class="fas fa-image"></i> 2. Scegli la fonte dell'immagine</h3>
                                <div class="image-source-options">
                                    <div class="source-option active" id="aiSourceOption" onclick="selectImageSource('ai')">
                                        <i class="fas fa-robot"></i>
                                        <h4>Generazione AI</h4>
                                        <p>Lascia che l'intelligenza artificiale crei una miniatura accattivante</p>
                                    </div>
                                    <div class="source-option" id="uploadSourceOption" onclick="selectImageSource('upload')">
                                        <i class="fas fa-upload"></i>
                                        <h4>Carica Immagine</h4>
                                        <p>Usa la tua immagine personalizzata</p>
                                    </div>
                                    <div class="source-option" id="frameSourceOption" onclick="selectImageSource('frame')">
                                        <i class="fas fa-film"></i>
                                        <h4>Frame dal Video</h4>
                                        <p>Estrai un fotogramma dal video caricato</p>
                                    </div>
                                </div>

                                <!-- AI Generation Options -->
                                <div id="aiGenerationOptions" class="generation-options active">
                                    <div class="form-group">
                                        <label><i class="fas fa-palette"></i> Stile Visivo</label>
                                        <select id="coverStyle" class="form-control">
                                            <option value="realistic">Realistico e Fotografico</option>
                                            <option value="cinematic">Cinematico ed Epico</option>
                                            <option value="cartoon">Cartoon e Animato</option>
                                            <option value="tech">Tecnologico e Futuristico</option>
                                            <option value="sport">Sportivo e Dinamico</option>
                                            <option value="gaming">Gaming e Action</option>
                                            <option value="business">Business e Professionale</option>
                                            <option value="minimal">Minimalista e Pulito</option>
                                        </select>
                                    </div>

                                    <div class="form-group">
                                        <label><i class="fas fa-lightbulb"></i> Descrizione del Contenuto (opzionale)</label>
                                        <textarea id="coverDescription" class="form-control" rows="3"
                                            placeholder="Descrivi il contenuto del video per una miniatura pi√π precisa (es: 'tutorial di programmazione Python', 'gameplay di Minecraft', 'ricetta di cucina italiana')"></textarea>
                                        <small>L'AI analizzer√† il video e questa descrizione per creare la miniatura perfetta</small>
                                    </div>
                                </div>

                                <!-- Upload Image Options -->
                                <div id="uploadImageOptions" class="generation-options" style="display: none;">
                                    <div class="cover-upload-area small" id="coverImageDropZone">
                                        <input type="file" id="coverImageInput" accept="image/*" style="display: none;">
                                        <div class="upload-icon">
                                            <i class="fas fa-image"></i>
                                        </div>
                                        <h4>Trascina qui l'immagine o clicca per selezionarla</h4>
                                        <p>Formati: JPG, PNG, WebP (consigliato 1920x1080)</p>
                                        <button class="btn-primary" onclick="document.getElementById('coverImageInput').click()">
                                            <i class="fas fa-folder-open"></i> Sfoglia Immagini
                                        </button>
                                    </div>
                                    <div id="coverImagePreview" class="image-preview" style="display: none;">
                                        <img id="coverImagePreviewImg" src="" alt="Preview">
                                        <button class="btn-remove" onclick="removeCoverImage()">
                                            <i class="fas fa-times"></i> Rimuovi
                                        </button>
                                    </div>
                                </div>

                                <!-- Frame Extraction Options -->
                                <div id="frameExtractionOptions" class="generation-options" style="display: none;">
                                    <div class="form-group">
                                        <label><i class="fas fa-clock"></i> Seleziona Secondo del Video</label>
                                        <input type="number" id="frameTimestamp" class="form-control" value="5" min="0" step="0.1">
                                        <small>Inserisci il secondo da cui estrarre il frame (es: 5.5 per 5 secondi e mezzo)</small>
                                    </div>
                                    <button class="btn-secondary" onclick="extractVideoFrame()">
                                        <i class="fas fa-camera"></i> Estrai Frame
                                    </button>
                                    <div id="extractedFramePreview" class="image-preview" style="display: none; margin-top: 15px;">
                                        <img id="extractedFrameImg" src="" alt="Frame estratto">
                                    </div>
                                </div>
                            </div>

                            <!-- Text Overlay Section -->
                            <div class="options-section">
                                <h3><i class="fas fa-font"></i> 3. Aggiungi testo alla miniatura (opzionale)</h3>
                                <div class="form-group">
                                    <label class="checkbox-label">
                                        <input type="checkbox" id="addTextOverlay" onchange="toggleTextOptions()">
                                        Aggiungi testo sulla miniatura
                                    </label>
                                </div>

                                <div id="textOverlayOptions" style="display: none;">
                                    <div class="form-group">
                                        <label><i class="fas fa-text-height"></i> Testo Principale</label>
                                        <input type="text" id="coverMainText" class="form-control"
                                            placeholder="Es: INCREDIBILE! Come fare...">
                                        <small>Testo breve e d'impatto (max 40 caratteri consigliati)</small>
                                    </div>

                                    <div class="form-group">
                                        <label><i class="fas fa-align-center"></i> Posizione Testo</label>
                                        <select id="textPosition" class="form-control">
                                            <option value="top">In Alto</option>
                                            <option value="center" selected>Centro</option>
                                            <option value="bottom">In Basso</option>
                                        </select>
                                    </div>

                                    <div class="form-row">
                                        <div class="form-group">
                                            <label><i class="fas fa-palette"></i> Colore Testo</label>
                                            <input type="color" id="textColor" class="form-control-color" value="#FFFFFF">
                                        </div>
                                        <div class="form-group">
                                            <label><i class="fas fa-fill"></i> Colore Sfondo</label>
                                            <input type="color" id="textBgColor" class="form-control-color" value="#000000">
                                        </div>
                                        <div class="form-group">
                                            <label><i class="fas fa-adjust"></i> Opacit√† Sfondo</label>
                                            <input type="range" id="textBgOpacity" class="form-control-range"
                                                min="0" max="100" value="70">
                                            <span id="textBgOpacityValue">70%</span>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Generate Button -->
                            <div class="action-section">
                                <button class="btn-generate" id="generateThumbnailBtn" onclick="generateThumbnail()">
                                    <i class="fas fa-magic"></i> Genera Miniatura AI
                                </button>
                            </div>

                            <!-- Progress and Status -->
                            <div id="coverGenerationProgress" class="progress-section" style="display: none;">
                                <div class="progress-bar">
                                    <div class="progress-fill" id="coverProgressFill"></div>
                                </div>
                                <p id="coverProgressText">Inizializzazione...</p>
                            </div>

                            <!-- Thumbnail Preview -->
                            <div id="coverThumbnailResult" class="result-section" style="display: none;">
                                <h3><i class="fas fa-eye"></i> Anteprima Miniatura</h3>
                                <div class="thumbnail-preview-container">
                                    <img id="generatedThumbnail" src="" alt="Miniatura generata">
                                    <div class="thumbnail-overlay">
                                        <span class="youtube-duration">10:25</span>
                                    </div>
                                </div>

                                <div class="thumbnail-actions">
                                    <button class="btn-primary" onclick="downloadThumbnail()">
                                        <i class="fas fa-download"></i> Scarica Miniatura
                                    </button>
                                    <button class="btn-secondary" onclick="regenerateThumbnail()">
                                        <i class="fas fa-sync-alt"></i> Rigenera
                                    </button>
                                    <button class="btn-secondary" onclick="saveThumbnailToProject()">
                                        <i class="fas fa-save"></i> Salva nel Progetto
                                    </button>
                                </div>

                                <!-- SEO Tips -->
                                <div class="seo-tips">
                                    <h4><i class="fas fa-lightbulb"></i> Consigli per Aumentare i Click</h4>
                                    <ul>
                                        <li><strong>Contrasto Alto:</strong> Usa colori brillanti e contrastanti per attirare l'attenzione</li>
                                        <li><strong>Visi Espressivi:</strong> Le miniature con volti ed emozioni ottengono pi√π click</li>
                                        <li><strong>Testo Leggibile:</strong> Usa font grandi e chiari, max 3-5 parole</li>
                                        <li><strong>Regola dei Terzi:</strong> Posiziona elementi importanti lungo le linee immaginarie</li>
                                        <li><strong>Formato:</strong> Usa 1280x720px (16:9), max 2MB</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="tab-pane" id="metadataTab">
                    <div class="metadata-container">
                        <!-- Header -->
                        <div class="metadata-header">
                            <h2><i class="fas fa-tags"></i> Metadati SEO YouTube</h2>
                            <p>Genera automaticamente titoli, descrizioni, hashtag e tag ottimizzati per YouTube con AI</p>
                        </div>

                        <!-- STEP 1: Upload Video -->
                        <div class="card mb-4">
                            <div class="card-header">
                                <h3><i class="fas fa-upload"></i> 1. Carica il video</h3>
                            </div>
                            <div class="card-body">
                                <div class="upload-area-advanced" id="metadataVideoUpload">
                                    <div class="upload-content">
                                        <i class="fas fa-video upload-icon"></i>
                                        <button class="upload-btn" onclick="document.getElementById('metadataVideoFile').click()">
                                            <i class="fas fa-upload"></i> Carica
                                        </button>
                                        <p class="upload-hint">Trascina qui il video o clicca per selezionare</p>
                                    </div>
                                    <div class="video-preview-container" id="metadataVideoPreview" style="display: none;">
                                        <video class="preview-video" controls></video>
                                        <button class="video-remove-btn" onclick="removeMetadataVideo()">
                                            <i class="fas fa-times"></i>
                                        </button>
                                    </div>
                                </div>
                                <input type="file" id="metadataVideoFile" accept="video/*" style="display: none;">
                            </div>
                        </div>

                        <!-- STEP 2: Impostazioni Generazione -->
                        <div class="card mb-4">
                            <div class="card-header">
                                <h3><i class="fas fa-sliders-h"></i> 2. Configura generazione</h3>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <!-- Numero Hashtag -->
                                    <div class="col-md-4 mb-3">
                                        <label for="numHashtags" class="form-label">
                                            <i class="fas fa-hashtag"></i> Numero Hashtag
                                        </label>
                                        <select class="form-control" id="numHashtags">
                                            <option value="1">1</option>
                                            <option value="2">2</option>
                                            <option value="3">3</option>
                                            <option value="4">4</option>
                                            <option value="5" selected>5</option>
                                            <option value="6">6</option>
                                            <option value="7">7</option>
                                            <option value="8">8</option>
                                            <option value="9">9</option>
                                            <option value="10">10</option>
                                            <option value="11">11</option>
                                            <option value="12">12</option>
                                            <option value="13">13</option>
                                            <option value="14">14</option>
                                            <option value="15">15</option>
                                            <option value="16">16</option>
                                            <option value="17">17</option>
                                            <option value="18">18</option>
                                            <option value="19">19</option>
                                            <option value="20">20</option>
                                        </select>
                                    </div>

                                    <!-- Numero Tag -->
                                    <div class="col-md-4 mb-3">
                                        <label for="numTags" class="form-label">
                                            <i class="fas fa-tag"></i> Numero Tag
                                        </label>
                                        <select class="form-control" id="numTags">
                                            <option value="1">1</option>
                                            <option value="2">2</option>
                                            <option value="3">3</option>
                                            <option value="4">4</option>
                                            <option value="5">5</option>
                                            <option value="6">6</option>
                                            <option value="7">7</option>
                                            <option value="8">8</option>
                                            <option value="9">9</option>
                                            <option value="10">10</option>
                                            <option value="11">11</option>
                                            <option value="12" selected>12</option>
                                            <option value="13">13</option>
                                            <option value="14">14</option>
                                            <option value="15">15</option>
                                            <option value="16">16</option>
                                            <option value="17">17</option>
                                            <option value="18">18</option>
                                            <option value="19">19</option>
                                            <option value="20">20</option>
                                        </select>
                                    </div>

                                    <!-- Usa Trascrizione -->
                                    <div class="col-md-4 mb-3">
                                        <label class="form-label">
                                            <i class="fas fa-closed-captioning"></i> Usa Trascrizione
                                        </label>
                                        <div class="form-check form-switch" style="padding-top: 8px;">
                                            <input class="form-check-input" type="checkbox" id="useTranscription">
                                            <label class="form-check-label" for="useTranscription">
                                                Analizza audio video
                                            </label>
                                        </div>
                                    </div>
                                </div>

                                <button class="btn btn-primary btn-lg w-100 mt-3" id="generateMetadataBtn" onclick="generateMetadata()" disabled>
                                    <i class="fas fa-magic"></i> Genera Metadati con AI
                                </button>

                                <!-- Progress Bar -->
                                <div id="metadataProgress" class="progress mt-3" style="display: none; height: 30px;">
                                    <div class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" style="width: 0%">
                                        <span id="metadataProgressText">Generazione in corso...</span>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- STEP 3: Personalizza Metadati -->
                        <div class="card mb-4" id="metadataResults" style="display: none;">
                            <div class="card-header">
                                <h3><i class="fas fa-edit"></i> 3. Personalizza i metadati</h3>
                            </div>
                            <div class="card-body">
                                <!-- Titolo -->
                                <div class="mb-4">
                                    <label for="metadataTitle" class="form-label">
                                        <i class="fas fa-heading"></i> Titolo
                                        <span class="badge bg-info" id="titleCharCount">0/100</span>
                                    </label>
                                    <textarea class="form-control"
                                              id="metadataTitle"
                                              rows="2"
                                              maxlength="100"
                                              placeholder="Titolo generato apparir√† qui..."
                                              readonly></textarea>

                                    <!-- Concatena al Titolo -->
                                    <div class="row mt-2">
                                        <div class="col-md-8">
                                            <input type="text"
                                                   class="form-control form-control-sm"
                                                   id="titlePrefix"
                                                   placeholder="Testo da aggiungere al titolo (es: NUOVO! o [ITA])">
                                        </div>
                                        <div class="col-md-4">
                                            <select class="form-control form-control-sm" id="titlePosition">
                                                <option value="start">Inizio</option>
                                                <option value="end">Fine</option>
                                            </select>
                                        </div>
                                    </div>
                                </div>

                                <!-- Descrizione -->
                                <div class="mb-4">
                                    <label for="metadataDescription" class="form-label">
                                        <i class="fas fa-align-left"></i> Descrizione
                                        <span class="badge bg-info" id="descCharCount">0/5000</span>
                                    </label>
                                    <textarea class="form-control"
                                              id="metadataDescription"
                                              rows="8"
                                              maxlength="5000"
                                              placeholder="Descrizione generata apparir√† qui..."
                                              readonly></textarea>

                                    <!-- Concatena alla Descrizione -->
                                    <div class="row mt-2">
                                        <div class="col-md-8">
                                            <textarea class="form-control form-control-sm"
                                                      id="descriptionExtra"
                                                      rows="2"
                                                      placeholder="Testo da aggiungere alla descrizione (es: link, CTA, contatti)"></textarea>
                                        </div>
                                        <div class="col-md-4">
                                            <select class="form-control form-control-sm" id="descriptionPosition">
                                                <option value="start">Inizio</option>
                                                <option value="end" selected>Fine</option>
                                            </select>
                                        </div>
                                    </div>
                                </div>

                                <!-- Hashtag -->
                                <div class="mb-4">
                                    <label for="metadataHashtags" class="form-label">
                                        <i class="fas fa-hashtag"></i> Hashtag
                                    </label>
                                    <textarea class="form-control"
                                              id="metadataHashtags"
                                              rows="3"
                                              placeholder="Hashtag generati appariranno qui..."
                                              readonly></textarea>

                                    <!-- Hashtag Fissi -->
                                    <input type="text"
                                           class="form-control form-control-sm mt-2"
                                           id="fixedHashtags"
                                           placeholder="Hashtag fissi (separati da virgola, es: #tutorial, #guida, #italiano)">
                                    <small class="text-muted">
                                        <i class="fas fa-info-circle"></i> Gli hashtag fissi hanno priorit√† e vengono sempre inclusi
                                    </small>
                                </div>

                                <!-- Tag -->
                                <div class="mb-4">
                                    <label for="metadataTags" class="form-label">
                                        <i class="fas fa-tag"></i> Tag
                                    </label>
                                    <textarea class="form-control"
                                              id="metadataTags"
                                              rows="3"
                                              placeholder="Tag generati appariranno qui..."
                                              readonly></textarea>

                                    <!-- Tag Fissi -->
                                    <input type="text"
                                           class="form-control form-control-sm mt-2"
                                           id="fixedTags"
                                           placeholder="Tag fissi (separati da virgola, es: tutorial, guida, italiano)">
                                    <small class="text-muted">
                                        <i class="fas fa-info-circle"></i> I tag fissi hanno priorit√† e vengono sempre inclusi
                                    </small>
                                </div>

                                <!-- Pulsanti Azione -->
                                <div class="row">
                                    <div class="col-md-6 mb-2">
                                        <button class="btn btn-primary w-100" onclick="applyCustomizations()">
                                            <i class="fas fa-check"></i> Applica Personalizzazioni
                                        </button>
                                    </div>
                                    <div class="col-md-6 mb-2">
                                        <button class="btn btn-warning w-100" onclick="regenerateMetadata()">
                                            <i class="fas fa-sync-alt"></i> Rigenera con AI
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- STEP 4: Anteprima e Copia -->
                        <div class="card" id="metadataFinalOutput" style="display: none;">
                            <div class="card-header">
                                <h3><i class="fas fa-eye"></i> 4. Anteprima e Copia</h3>
                            </div>
                            <div class="card-body">
                                <div class="metadata-preview">
                                    <h5>Metadati pronti per YouTube:</h5>
                                    <pre id="formattedMetadata" class="metadata-output"></pre>
                                </div>

                                <button class="btn btn-success btn-lg w-100" onclick="copyAllMetadata()">
                                    <i class="fas fa-copy"></i> Copia Tutto
                                </button>

                                <div class="alert alert-info mt-3">
                                    <i class="fas fa-lightbulb"></i>
                                    <strong>Suggerimenti SEO:</strong>
                                    <ul class="mb-0 mt-2">
                                        <li>Titolo: 45-70 caratteri ideali, keyword all'inizio</li>
                                        <li>Descrizione: Prime 150 caratteri con keyword + CTA</li>
                                        <li>Hashtag: Massimo 3-5 rilevanti, evita keyword stuffing</li>
                                        <li>Tag: Mix keyword generiche + specifiche</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="tab-pane" id="audioTab">
                    <div class="translation-container">
                        <div class="translation-header">
                            <h2>üåç Traduzione Audio Video</h2>
                            <p>Traduci automaticamente l'audio del tuo video in un'altra lingua con AI</p>
                        </div>

                        <div class="alert alert-info">
                            <strong>‚ÑπÔ∏è Come funziona:</strong><br>
                            1. Carica il video da tradurre (drag & drop o click)<br>
                            2. Scegli la lingua sorgente (default: rilevamento automatico)<br>
                            3. Scegli la lingua di destinazione<br>
                            4. L'AI trascriver√†, tradurr√† e generer√† nuovo audio<br>
                            5. Scarica il video tradotto quando pronto
                        </div>

                        <div class="alert alert-warning">
                            <strong>‚ö†Ô∏è Attenzione:</strong><br>
                            ‚Ä¢ La traduzione pu√≤ richiedere 3-10 minuti per video brevi<br>
                            ‚Ä¢ Il lip-sync richiede GPU NVIDIA e pu√≤ richiedere 20-30 minuti<br>
                            ‚Ä¢ Assicurati che il video abbia audio chiaro per migliori risultati
                        </div>

                        <!-- Video Upload Section -->
                        <div class="translation-section">
                            <h3>üìπ Carica Video da Tradurre</h3>

                            <!-- Upload Area -->
                            <div class="upload-area-advanced" id="translationVideoUploadArea">
                                <div class="upload-content">
                                    <i class="fas fa-video upload-icon"></i>
                                    <p style="margin: 10px 0;">Trascina qui il video o clicca per caricare</p>
                                    <button class="upload-btn" onclick="document.getElementById('translationVideoFile').click()">
                                        <i class="fas fa-upload"></i> Carica Video
                                    </button>
                                </div>
                                <div class="upload-preview" id="translationVideoPreviewOverlay" style="display: none;">
                                    <video controls class="preview-video-overlay" id="translationVideoPreviewPlayer">
                                        Your browser does not support the video tag.
                                    </video>
                                    <button class="preview-remove-btn" onclick="removeTranslationVideo(event)" title="Elimina video">
                                        <i class="fas fa-trash-alt"></i>
                                    </button>
                                </div>
                            </div>
                            <input type="file" id="translationVideoFile" class="file-input" accept="video/*" style="display: none;">

                            <!-- File Info -->
                            <div class="file-info" id="translationVideoInfo" style="display: none; margin-top: 15px;">
                                <div class="file-name-section">
                                    <i class="fas fa-video"></i> <span id="translationVideoName"></span>
                                </div>
                                <div class="file-size" id="translationVideoSize"></div>
                            </div>
                        </div>

                        <!-- Translation Settings -->
                        <div class="translation-section">
                            <h3>‚öôÔ∏è Impostazioni Traduzione</h3>

                            <div class="translation-settings" style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                                <!-- Lingua Video Sorgente -->
                                <div class="setting-group">
                                    <label for="sourceLanguage">üé§ Lingua Video Sorgente</label>
                                    <select id="sourceLanguage" class="form-control language-select">
                                        <option value="">-- Caricamento lingue... --</option>
                                    </select>
                                    <small>Lingua parlata nel video (default: rilevamento automatico)</small>
                                </div>

                                <!-- Lingua Destinazione -->
                                <div class="setting-group">
                                    <label for="targetLanguage">üåê Lingua Destinazione</label>
                                    <select id="targetLanguage" class="form-control language-select">
                                        <option value="">-- Caricamento lingue... --</option>
                                    </select>
                                    <small>Lingua in cui tradurre il video</small>
                                </div>
                            </div>
                        </div>

                        <!-- Translation Button -->
                        <div class="translation-actions">
                            <button class="btn-primary btn-large" onclick="startVideoTranslation()" id="translateBtn">
                                <i class="fas fa-language"></i> Avvia Traduzione
                            </button>
                        </div>

                        <!-- Translation Progress -->
                        <div id="translationProgress" style="display: none; margin-top: 30px;">
                            <div class="progress-container">
                                <div class="progress-header">
                                    <h3>üîÑ Traduzione in Corso</h3>
                                    <span id="translationPercentage">0%</span>
                                </div>
                                <div class="progress-bar-container">
                                    <div class="progress-bar" id="translationProgressBar" style="width: 0%;"></div>
                                </div>
                                <p id="translationMessage">Inizializzazione...</p>
                                <div class="progress-actions">
                                    <button class="btn-danger" onclick="cancelTranslation()">
                                        <i class="fas fa-stop"></i> Annulla
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- Translation Result -->
                        <div id="translationResult" style="display: none; margin-top: 30px;">
                            <div class="result-container">
                                <h3>‚úÖ Traduzione Completata!</h3>
                                <p>Il tuo video √® stato tradotto con successo.</p>

                                <div class="result-preview">
                                    <video id="translatedVideoPlayer" controls style="width: 100%; max-width: 640px; border-radius: 10px;">
                                        Your browser does not support video playback.
                                    </video>
                                </div>

                                <div class="result-actions">
                                    <button class="btn-primary" onclick="downloadTranslatedVideo()">
                                        <i class="fas fa-download"></i> Scarica Video Tradotto
                                    </button>
                                    <button class="btn-secondary" onclick="resetTranslation()">
                                        <i class="fas fa-redo"></i> Nuova Traduzione
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="tab-pane" id="youtubeTab">
                    <div class="coming-soon">
                        <i class="fab fa-youtube"></i>
                        <h3>Caricamento YouTube</h3>
                        <p>Il caricamento automatico su YouTube sar√† disponibile presto!</p>
                    </div>
                </div>

                <!-- Recorder Tab -->
                <div class="tab-pane" id="recorderTab">
                    <div class="recorder-container">
                        <div class="recorder-header">
                            <h2>üé• Screen Recorder</h2>
                            <p>Registra schermo, finestre e tab del browser</p>
                        </div>

                        <div class="alert alert-info">
                            <strong>‚ÑπÔ∏è Come funziona:</strong><br>
                            1. Clicca "Avvia Registrazione"<br>
                            2. Il Browser mostra popup: scegli <strong>Scheda/Finestra/Schermo</strong><br>
                            3. Attiva/disattiva <strong>"Condividi audio"</strong> nel popup<br>
                            4. La registrazione parte automaticamente<br>
                            5. Le registrazioni salvate saranno disponibili nel <strong>File Manager</strong>
                        </div>

                        <div class="recording-indicator" id="recording-indicator-main">
                            <div class="rec-dot"></div>
                            <div class="status-info">
                                <h3>üî¥ Registrazione in corso</h3>
                                <p>Durata: <span id="duration-main">00:00</span></p>
                            </div>
                            <button class="btn btn-danger" onclick="stopRecordingMain()">‚èπÔ∏è Ferma Registrazione</button>
                        </div>

                        <div class="controls">
                            <div class="control-group">
                                <label>üìπ Qualit√† Video</label>
                                <select id="video-quality-main">
                                    <option value="1280x720">HD 720p (Veloce)</option>
                                    <option value="1920x1080" selected>Full HD 1080p (Consigliato)</option>
                                    <option value="2560x1440">2K 1440p (Alta qualit√†)</option>
                                    <option value="3840x2160">4K 2160p (Massima qualit√†)</option>
                                </select>
                            </div>

                            <div class="control-group">
                                <label>‚öôÔ∏è Frame Rate</label>
                                <select id="framerate-main">
                                    <option value="24">24 FPS (Cinema)</option>
                                    <option value="30" selected>30 FPS (Standard)</option>
                                    <option value="60">60 FPS (Smooth)</option>
                                </select>
                            </div>
                        </div>

                        <button class="btn-primary" id="btn-start-main" onclick="startRecordingMain()">
                            üé¨ Avvia Registrazione
                        </button>
                    </div>
                </div>

                <!-- Transcription Tab -->
                <div class="tab-pane" id="transcriptionTab">
                    <div class="transcription-container">
                        <div class="transcription-header">
                            <h2>üìù Trascrizione Video</h2>
                            <p>Genera sottotitoli automatici per YouTube (SRT) e trascrizione in formato testo</p>
                        </div>

                        <div class="alert alert-info">
                            <strong>‚ÑπÔ∏è Come funziona:</strong><br>
                            1. Carica un video da trascrivere<br>
                            2. Clicca "Avvia Trascrizione"<br>
                            3. Il sistema genera automaticamente i sottotitoli<br>
                            4. Scarica i file SRT (YouTube) e TXT dal File Manager
                        </div>

                        <!-- Upload area for transcription -->
                        <div class="upload-card">
                            <h3><i class="fas fa-video"></i> Video da Trascrivere</h3>
                            <div class="upload-area-advanced" id="transcriptionVideoUpload">
                                <div class="upload-content">
                                    <i class="fas fa-video upload-icon"></i>
                                    <button class="upload-btn" onclick="document.getElementById('transcriptionVideoFile').click()">
                                        <i class="fas fa-upload"></i> Carica
                                    </button>
                                </div>
                                <div class="preview-overlay" id="transcriptionVideoPreviewOverlay" style="display: none;">
                                    <video class="preview-video-overlay" controls></video>
                                    <button class="remove-file-btn" onclick="removeTranscriptionFile(event)">
                                        <i class="fas fa-trash-alt"></i>
                                    </button>
                                </div>
                            </div>
                            <input type="file" id="transcriptionVideoFile" accept="video/*" style="display: none;">
                            <div class="file-info" id="transcriptionVideoInfo" style="display: none;">
                                <i class="fas fa-check-circle"></i>
                                <span id="transcriptionVideoName"></span>
                            </div>
                        </div>

                        <!-- Transcription progress -->
                        <div id="transcriptionProgress" style="display: none; margin: 30px 0;">
                            <div style="background: white; padding: 25px; border-radius: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.1);">
                                <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 15px;">
                                    <div class="loading" style="display: inline-block; width: 20px; height: 20px;"></div>
                                    <span id="transcriptionStatus" style="color: #667eea; font-weight: 600;">Trascrizione in corso...</span>
                                </div>
                                <div style="width: 100%; height: 8px; background: #e0e0e0; border-radius: 5px; overflow: hidden;">
                                    <div id="transcriptionBar" style="width: 0%; height: 100%; background: linear-gradient(90deg, #667eea, #764ba2); transition: width 0.3s;"></div>
                                </div>
                            </div>
                        </div>

                        <!-- Transcription results -->
                        <div id="transcriptionResults" style="display: none; margin: 30px 0;">
                            <div style="background: white; padding: 25px; border-radius: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.1);">
                                <h3 style="color: #667eea; margin-bottom: 20px;">
                                    <i class="fas fa-check-circle"></i> Trascrizione Completata!
                                </h3>
                                <p style="margin-bottom: 20px;">I file sono stati salvati nel File Manager:</p>
                                <ul style="list-style: none; padding: 0;">
                                    <li style="padding: 10px; background: #f8f9fa; border-radius: 8px; margin-bottom: 10px;">
                                        <i class="fas fa-file-alt" style="color: #667eea;"></i>
                                        <strong id="srtFileName">sottotitoli.srt</strong> - Formato YouTube
                                    </li>
                                    <li style="padding: 10px; background: #f8f9fa; border-radius: 8px;">
                                        <i class="fas fa-file-text" style="color: #667eea;"></i>
                                        <strong id="txtFileName">trascrizione.txt</strong> - Formato Testo
                                    </li>
                                </ul>
                                <div style="margin-top: 20px; display: flex; gap: 10px;">
                                    <button class="btn-primary" onclick="showTab('files')">
                                        <i class="fas fa-folder-open"></i> Vai al File Manager
                                    </button>
                                    <button class="btn-secondary" onclick="resetTranscription()">
                                        <i class="fas fa-redo"></i> Nuova Trascrizione
                                    </button>
                                </div>
                            </div>
                        </div>

                        <button class="btn-primary" id="btn-start-transcription" onclick="startTranscription()" disabled>
                            üìù Avvia Trascrizione
                        </button>
                    </div>
                </div>

                <!-- Files Tab -->
                <div class="tab-pane" id="filesTab">
                    <div class="files-manager-container">
                        <div class="files-header" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 30px; border-radius: 15px; margin-bottom: 30px; text-align: center;">
                            <h2 style="margin: 0; font-size: 2rem;"><i class="fas fa-folder-open"></i> File Manager</h2>
                            <p style="margin: 10px 0 0 0; opacity: 0.9;">Gestisci tutti i tuoi file caricati e registrazioni</p>
                        </div>

                        <div class="files-actions" style="background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1); margin-bottom: 30px; display: flex; gap: 15px; justify-content: space-between; align-items: center;">
                            <button class="btn-secondary" onclick="loadFilesManager()">
                                <i class="fas fa-sync-alt"></i> Aggiorna
                            </button>
                            <button class="btn-danger" onclick="deleteAllFilesManager()">
                                <i class="fas fa-trash-alt"></i> Elimina Tutti
                            </button>
                        </div>

                        <div id="filesManagerContainer" style="min-height: 300px;">
                            <p style="text-align: center; padding: 40px; color: #6c757d;">Caricamento file...</p>
                        </div>
                    </div>
                </div>

                <!-- Settings Tab (NEW) -->
                <div class="tab-pane" id="settingsTab">
                    <!-- Gestione Impostazioni -->
                    <div class="settings-section">
                        <h2><i class="fas fa-cog"></i> Gestione Impostazioni</h2>
                        <div class="settings-content">
                            <div class="settings-actions">
                                <button class="btn-warning" onclick="resetSettings()" title="Ripristina tutte le impostazioni ai valori predefiniti">
                                    <i class="fas fa-undo"></i> Ripristina Default
                                </button>
                                <button class="btn-secondary" onclick="exportSettings()" title="Scarica le tue impostazioni come file di backup">
                                    <i class="fas fa-download"></i> Esporta
                                </button>
                                <label class="btn-secondary" for="importSettingsFile" title="Carica impostazioni da un file di backup">
                                    <i class="fas fa-upload"></i> Importa
                                </label>
                                <input type="file" id="importSettingsFile" accept=".json" onchange="importSettings(event)" style="display: none;">
                            </div>
                            <div class="settings-note">
                                <p><i class="fas fa-info-circle"></i> Le impostazioni vengono salvate automaticamente quando vengono modificate. Ogni cambio di posizione, timing, modalit√† audio, e altre preferenze viene memorizzato nel browser per le prossime sessioni.</p>
                            </div>
                        </div>
                    </div>

                    <!-- Impostazioni Qualit√† -->
                    <div class="quality-section">
                        <h2><i class="fas fa-video"></i> Impostazioni Qualit√†</h2>
                        <div class="quality-content">
                            <div class="quality-preset">
                                <label>Preimpostazione qualit√†</label>
                                <select class="quality-select" id="qualityPreset">
                                    <option value="balanced">üéØ Bilanciato - 1080p, 30fps (Consigliato)</option>
                                    <option value="high">‚ö° Alta Qualit√† - 4K, 60fps</option>
                                    <option value="fast">üöÄ Veloce - 720p, 30fps</option>
                                    <option value="custom">‚öôÔ∏è Personalizzato</option>
                                </select>
                            </div>
                            <div class="quality-note">
                                <p>Scegli il compromesso tra velocit√† e qualit√†</p>
                            </div>
                        </div>
                    </div>

                    <!-- Feature Toggles -->
                    <div class="feature-toggles">
                        <h2><i class="fas fa-sliders-h"></i> Impostazioni Funzionalit√†</h2>
                        <div class="toggles-grid">
                            <div class="toggle-item">
                                <label class="toggle toggle-green">
                                    <input type="checkbox" id="logoOverlay">
                                    <span class="slider"></span>
                                </label>
                                <span>Sovrapposizione Logo</span>
                            </div>
                            <div class="toggle-item">
                                <label class="toggle toggle-blue">
                                    <input type="checkbox" id="callToAction">
                                    <span class="slider"></span>
                                </label>
                                <span>Sovrapposizione Call to Action</span>
                            </div>
                            <div class="toggle-item">
                                <label class="toggle">
                                    <input type="checkbox" id="videoTranscription">
                                    <span class="slider"></span>
                                </label>
                                <span>Trascrizione Video</span>
                            </div>
                            <div class="toggle-item">
                                <label class="toggle">
                                    <input type="checkbox" id="audioTranslation">
                                    <span class="slider"></span>
                                </label>
                                <span>Traduzione Audio Video</span>
                            </div>
                            <div class="toggle-item">
                                <label class="toggle">
                                    <input type="checkbox" id="coverGeneration">
                                    <span class="slider"></span>
                                </label>
                                <span>Generazione Copertina</span>
                            </div>
                            <div class="toggle-item">
                                <label class="toggle">
                                    <input type="checkbox" id="metadataGeneration">
                                    <span class="slider"></span>
                                </label>
                                <span>Generazione Metadati</span>
                            </div>
                            <div class="toggle-item">
                                <label class="toggle">
                                    <input type="checkbox" id="youtubeUpload">
                                    <span class="slider"></span>
                                </label>
                                <span>Caricamento YouTube</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Action Buttons -->
            <div class="action-section">
                <button class="btn-primary main-action" onclick="processVideo()" id="processBtn">
                    <i class="fas fa-video"></i> Elabora Video
                </button>
                <button class="btn-danger" onclick="stopProcessing()" id="stopBtn" style="display: none;">
                    <i class="fas fa-stop"></i> Ferma
                </button>
            </div>
        </div>
    </main>

    <!-- Processing Loading Modal -->
    <div class="processing-modal" id="processingModal">
        <div class="processing-modal-content">
            <h2 class="processing-title">Elaborazione in corso...</h2>
            <div class="spinner"></div>
            <div class="processing-percentage" id="processingPercentage">0%</div>
            <p class="processing-message" id="processingMessage">Preparazione elaborazione...</p>
            <p class="processing-time" id="processingTime">Calcolo tempo rimanente...</p>
        </div>
    </div>

    <!-- Preview Modal -->
    <div class="modal" id="previewModal" onclick="closePreviewModal()">
        <div class="modal-content" onclick="event.stopPropagation()">
            <div class="modal-header">
                <h2><i class="fas fa-eye"></i> Anteprima Video Finale</h2>
                <button class="modal-close-btn" onclick="closePreviewModal()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <div class="modal-body">
                <div class="preview-area">
                    <div class="preview-video-container">
                        <canvas id="previewCanvas" width="1280" height="720"></canvas>
                        <div class="preview-overlay" id="previewOverlay">
                            <div class="preview-message">
                                <i class="fas fa-play-circle"></i>
                                <p>Carica video principale e CTA per vedere l'anteprima</p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="preview-controls">
                        <button class="control-btn" id="previewPlayBtn" onclick="togglePreview()">
                            <i class="fas fa-play"></i> Play
                        </button>
                        <button class="control-btn" onclick="resetPreview()">
                            <i class="fas fa-refresh"></i> Reset
                        </button>
                        <div class="timeline-container">
                            <input type="range" id="previewTimeline" class="timeline-slider" 
                                   min="0" max="100" value="0" 
                                   oninput="seekPreview(this.value)">
                            <div class="time-display">
                                <span id="currentTime">00:00</span> / <span id="totalTime">00:00</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="preview-info">
                        <div class="info-item">
                            <i class="fas fa-info-circle"></i>
                            <span>L'anteprima mostra come apparir√† il video finale con logo e CTA sovrapposti</span>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="modal-footer">
                <button class="btn-secondary" onclick="closePreviewModal()">
                    <i class="fas fa-times"></i> Chiudi
                </button>
                <button class="btn-primary" onclick="processVideoFromPreview()">
                    <i class="fas fa-cogs"></i> Elabora Video
                </button>
            </div>
        </div>
    </div>

    <!-- Processing Confirmation Modal -->
    <div class="modal" id="processingConfirmModal" style="display: none;" onclick="closeProcessingConfirmModal()">
        <div class="modal-content processing-confirm-content" onclick="event.stopPropagation()">
            <div class="modal-header processing-confirm-header">
                <h2>Conferma Elaborazione</h2>
                <button class="modal-close-btn" onclick="closeProcessingConfirmModal()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <div class="modal-body processing-confirm-body">
                <p>Le seguenti funzionalit√† verranno applicate al tuo video:</p>
                
                <div class="selected-features" id="selectedFeaturesList">
                    <!-- Le funzionalit√† selezionate verranno inserite qui dinamicamente -->
                </div>
                
                <div class="processing-info">
                    <div class="info-row">
                        <i class="fas fa-clock"></i>
                        <span>Tempo stimato: <strong id="estimatedTime">2-5 minuti</strong></span>
                    </div>
                    <div class="info-row">
                        <i class="fas fa-video"></i>
                        <span>Qualit√†: <strong id="selectedQuality">Ultra (1080p)</strong></span>
                    </div>
                </div>
            </div>
            
            <div class="modal-footer processing-confirm-footer">
                <button class="btn-secondary" onclick="closeProcessingConfirmModal()">
                    <i class="fas fa-times"></i> Annulla
                </button>
                <button class="btn-primary" onclick="confirmProcessing()">
                    <i class="fas fa-play"></i> Avvia Elaborazione
                </button>
            </div>
        </div>
    </div>

    <!-- Missing Files Modal -->
    <div class="modal" id="missingFilesModal" style="display: none;" onclick="closeMissingFilesModal()">
        <div class="modal-content missing-files-content" onclick="event.stopPropagation()">
            <div class="modal-header missing-files-header">
                <div class="missing-files-icon">
                    <i class="fas fa-exclamation-circle"></i>
                </div>
                <h2>File Mancanti</h2>
            </div>
            
            <div class="modal-body missing-files-body">
                <p id="missingFilesMessage">Per elaborare il video devi caricare tutti i file richiesti:</p>
                
                <div class="missing-files-list" id="missingFilesList">
                    <!-- I file mancanti verranno inseriti qui dinamicamente -->
                </div>
                
                <div class="files-help">
                    <h4>Come caricare i file:</h4>
                    <ul>
                        <li><i class="fas fa-mouse-pointer"></i> Clicca su "Carica File" nelle sezioni</li>
                        <li><i class="fas fa-hand-paper"></i> Trascina i file direttamente sulle aree</li>
                        <li><i class="fas fa-check-circle"></i> Verifica che i file siano stati caricati correttamente</li>
                    </ul>
                </div>
            </div>
            
            <div class="modal-footer missing-files-footer">
                <button class="btn-primary" onclick="closeMissingFilesModal()">
                    <i class="fas fa-check"></i> Ho Capito
                </button>
            </div>
        </div>
    </div>

    <!-- Validation Modal -->
    <div class="modal" id="validationModal" style="display: none;" onclick="closeValidationModal()">
        <div class="modal-content validation-modal-content" onclick="event.stopPropagation()">
            <div class="modal-header validation-header">
                <div class="validation-icon">
                    <i class="fas fa-exclamation-triangle"></i>
                </div>
                <h2>Configurazione Richiesta</h2>
            </div>
            
            <div class="modal-body validation-body">
                <p id="validationMessage">Seleziona almeno una funzionalit√† dalle "Impostazioni Funzionalit√†" prima di elaborare il video.</p>
                
                <div class="validation-features">
                    <h4>Funzionalit√† Disponibili:</h4>
                    <ul>
                        <li><i class="fas fa-image"></i> Sovrapposizione Logo</li>
                        <li><i class="fas fa-play-circle"></i> Sovrapposizione Call to Action</li>
                        <li><i class="fas fa-closed-captioning"></i> Trascrizione Video</li>
                        <li><i class="fas fa-language"></i> Traduzione Audio Video</li>
                        <li><i class="fas fa-file-image"></i> Generazione Copertina</li>
                        <li><i class="fas fa-tags"></i> Generazione Metadati</li>
                        <li><i class="fas fa-upload"></i> Caricamento YouTube</li>
                    </ul>
                </div>
            </div>
            
            <div class="modal-footer validation-footer">
                <button class="btn-secondary" onclick="closeValidationModal()">
                    <i class="fas fa-times"></i> Annulla
                </button>
                <button class="btn-primary" onclick="goToFeatures()">
                    <i class="fas fa-cog"></i> Vai alle Impostazioni
                </button>
            </div>
        </div>
    </div>

    <!-- Generic Confirm/Alert Modal -->
    <div class="modal" id="confirmModal" style="display: none;">
        <div class="modal-content confirm-modal-content" onclick="event.stopPropagation()">
            <div class="modal-header confirm-modal-header">
                <div class="confirm-modal-icon" id="confirmModalIcon">
                    <i class="fas fa-question-circle"></i>
                </div>
                <h2 id="confirmModalTitle">Conferma</h2>
                <button class="modal-close-btn" onclick="closeConfirmModal(false)">
                    <i class="fas fa-times"></i>
                </button>
            </div>

            <div class="modal-body confirm-modal-body">
                <p id="confirmModalMessage"></p>
            </div>

            <div class="modal-footer confirm-modal-footer">
                <button class="btn-secondary" id="confirmModalCancelBtn" onclick="closeConfirmModal(false)">
                    <i class="fas fa-times"></i> Annulla
                </button>
                <button class="btn-primary" id="confirmModalConfirmBtn" onclick="closeConfirmModal(true)">
                    <i class="fas fa-check"></i> Conferma
                </button>
            </div>
        </div>
    </div>

    <!-- Alert Modal - Sistema notifiche personalizzato -->
    <div class="modal" id="customAlertModal" style="display: none;" onclick="closeCustomAlert()">
        <div class="modal-content custom-alert-content" onclick="event.stopPropagation()" style="max-width: 500px;">
            <div class="modal-header" id="customAlertHeader">
                <div style="display: flex; align-items: center; gap: 15px;">
                    <div id="customAlertIcon" style="font-size: 2rem;"></div>
                    <h2 id="customAlertTitle">Notifica</h2>
                </div>
                <button class="modal-close-btn" onclick="closeCustomAlert()">
                    <i class="fas fa-times"></i>
                </button>
            </div>

            <div class="modal-body" id="customAlertBody">
                <p id="customAlertMessage" style="font-size: 1.1rem; line-height: 1.6;"></p>
            </div>

            <div class="modal-footer" id="customAlertFooter">
                <button class="btn-primary" onclick="closeCustomAlert()" id="customAlertOkBtn">
                    <i class="fas fa-check"></i> OK
                </button>
            </div>
        </div>
    </div>

    <!-- Confirm Modal - Dialogo conferma personalizzato -->
    <div class="modal" id="customConfirmModal" style="display: none;" onclick="closeCustomConfirm(false)">
        <div class="modal-content custom-confirm-content" onclick="event.stopPropagation()" style="max-width: 500px;">
            <div class="modal-header">
                <div style="display: flex; align-items: center; gap: 15px;">
                    <div style="font-size: 2rem;">‚ùì</div>
                    <h2 id="customConfirmTitle">Conferma</h2>
                </div>
                <button class="modal-close-btn" onclick="closeCustomConfirm(false)">
                    <i class="fas fa-times"></i>
                </button>
            </div>

            <div class="modal-body">
                <p id="customConfirmMessage" style="font-size: 1.1rem; line-height: 1.6;"></p>
            </div>

            <div class="modal-footer" style="display: flex; gap: 10px; justify-content: flex-end;">
                <button class="btn-secondary" onclick="closeCustomConfirm(false)">
                    <i class="fas fa-times"></i> Annulla
                </button>
                <button class="btn-primary" onclick="closeCustomConfirm(true)" id="customConfirmYesBtn">
                    <i class="fas fa-check"></i> Conferma
                </button>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="/static/js/modern-app.js?v=2"></script>
    <script src="/static/js/metadata.js"></script>

    <!-- Recorder Script -->
    <script>
        // Tab switching function
        function showTab(tabName) {
            // Hide all tabs
            const tabs = document.querySelectorAll('.tab-pane');
            tabs.forEach(tab => tab.classList.remove('active'));

            // Remove active from all buttons
            const buttons = document.querySelectorAll('.tab-btn');
            buttons.forEach(btn => btn.classList.remove('active'));

            // Remove active from all navbar links
            const navLinks = document.querySelectorAll('.nav-link');
            navLinks.forEach(link => link.classList.remove('active'));

            // Show selected tab
            const selectedTab = document.getElementById(tabName + 'Tab');
            if (selectedTab) {
                selectedTab.classList.add('active');
            }

            // Activate corresponding button
            const allButtons = document.querySelectorAll('.tab-btn');
            allButtons.forEach(btn => {
                if (btn.onclick && btn.onclick.toString().includes(`'${tabName}'`)) {
                    btn.classList.add('active');
                }
            });

            // Activate corresponding navbar link
            if (tabName === 'settings') {
                // Se stiamo aprendo le impostazioni, attiva il link Impostazioni
                const settingsLink = document.querySelector('.nav-link[onclick*="settings"]');
                if (settingsLink) {
                    settingsLink.classList.add('active');
                }
            } else {
                // Altrimenti attiva il link Home per tutte le altre tab
                const homeLink = document.querySelector('.nav-link[href="/"]');
                if (homeLink) {
                    homeLink.classList.add('active');
                }
            }
        }

        // Recorder variables
        let mediaRecorderMain = null;
        let recordedChunksMain = [];
        let recordingStartTimeMain = null;
        let durationIntervalMain = null;
        let currentStreamMain = null;

        // Start recording
        async function startRecordingMain() {
            try {
                const quality = document.getElementById('video-quality-main').value;
                const framerate = parseInt(document.getElementById('framerate-main').value);
                const [width, height] = quality.split('x').map(Number);

                const displayMediaOptions = {
                    video: {
                        cursor: 'always',
                        width: { ideal: width },
                        height: { ideal: height },
                        frameRate: { ideal: framerate, max: 60 }
                    },
                    audio: true
                };

                const screenStream = await navigator.mediaDevices.getDisplayMedia(displayMediaOptions);
                currentStreamMain = screenStream;

                recordedChunksMain = [];

                let mimeType = 'video/webm;codecs=vp9';
                if (!MediaRecorder.isTypeSupported(mimeType)) {
                    mimeType = 'video/webm;codecs=vp8';
                }
                if (!MediaRecorder.isTypeSupported(mimeType)) {
                    mimeType = 'video/webm';
                }

                const bitrates = {
                    '1280x720': 2500000,
                    '1920x1080': 5000000,
                    '2560x1440': 8000000,
                    '3840x2160': 15000000
                };

                mediaRecorderMain = new MediaRecorder(screenStream, {
                    mimeType: mimeType,
                    videoBitsPerSecond: bitrates[quality] || 5000000
                });

                mediaRecorderMain.ondataavailable = (event) => {
                    if (event.data.size > 0) {
                        recordedChunksMain.push(event.data);
                    }
                };

                mediaRecorderMain.onstop = saveRecordingMain;

                screenStream.getVideoTracks()[0].addEventListener('ended', () => {
                    console.log('üõë Utente ha fermato condivisione dal browser');
                    stopRecordingMain();
                });

                mediaRecorderMain.start(1000);

                document.getElementById('recording-indicator-main').classList.add('active');
                document.getElementById('btn-start-main').disabled = true;

                recordingStartTimeMain = Date.now();
                durationIntervalMain = setInterval(updateDurationMain, 1000);

                console.log('‚úÖ Registrazione avviata');

            } catch (error) {
                console.error('Errore start recording:', error);

                if (error.name === 'NotAllowedError') {
                    alert('‚ùå Permesso negato. Devi autorizzare la cattura schermo.');
                } else if (error.name === 'NotFoundError') {
                    alert('‚ùå Nessuna sorgente disponibile per la cattura.');
                } else {
                    alert('‚ùå Errore: ' + error.message);
                }
            }
        }

        // Stop recording
        function stopRecordingMain() {
            if (mediaRecorderMain && mediaRecorderMain.state !== 'inactive') {
                mediaRecorderMain.stop();
            }

            if (currentStreamMain) {
                currentStreamMain.getTracks().forEach(track => track.stop());
                currentStreamMain = null;
            }

            document.getElementById('recording-indicator-main').classList.remove('active');
            document.getElementById('btn-start-main').disabled = false;

            if (durationIntervalMain) {
                clearInterval(durationIntervalMain);
                durationIntervalMain = null;
            }

            console.log('‚èπÔ∏è Registrazione fermata');
        }

        // Update duration
        function updateDurationMain() {
            const elapsed = Math.floor((Date.now() - recordingStartTimeMain) / 1000);
            const minutes = Math.floor(elapsed / 60);
            const seconds = elapsed % 60;
            document.getElementById('duration-main').textContent =
                `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
        }

        // Save recording
        async function saveRecordingMain() {
            if (recordedChunksMain.length === 0) {
                alert('‚ùå Nessun dato registrato');
                return;
            }

            const blob = new Blob(recordedChunksMain, {
                type: 'video/webm'
            });

            const sizeM = (blob.size / 1024 / 1024).toFixed(1);
            console.log(`üíæ Salvando ${sizeM}MB...`);

            const now = new Date();
            const year = now.getFullYear();
            const month = String(now.getMonth() + 1).padStart(2, '0');
            const day = String(now.getDate()).padStart(2, '0');
            const hours = String(now.getHours()).padStart(2, '0');
            const minutes = String(now.getMinutes()).padStart(2, '0');
            const seconds = String(now.getSeconds()).padStart(2, '0');

            const timestamp = `${year}-${month}-${day}_${hours}-${minutes}-${seconds}`;
            const filename = `recording_${timestamp}.webm`;

            try {
                console.log('üì§ Upload al server...');

                const formData = new FormData();
                formData.append('file', blob, filename);

                const response = await fetch('/api/upload', {
                    method: 'POST',
                    body: formData
                });

                if (response.ok) {
                    const data = await response.json();
                    console.log('‚úÖ Upload server completato:', data);
                    alert(`‚úÖ Registrazione salvata! (${sizeM}MB)\nDisponibile nel File Manager`);
                } else {
                    console.warn('‚ö†Ô∏è Upload server fallito');
                    alert(`‚ö†Ô∏è Upload al server fallito. Prova a salvare manualmente.`);
                }
            } catch (error) {
                console.error('Errore upload server:', error);
                alert(`‚ö†Ô∏è Errore upload al server: ${error.message}`);
            }

            recordedChunksMain = [];
        }

        // Transcription Functions
        let transcriptionVideoFileId = null;

        // Handle transcription video file selection
        document.getElementById('transcriptionVideoFile')?.addEventListener('change', async function(e) {
            const file = e.target.files[0];
            if (!file) return;

            console.log('üìπ Video selezionato per trascrizione:', file.name);

            try {
                // Upload file
                const formData = new FormData();
                formData.append('file', file);

                const response = await fetch('/api/upload', {
                    method: 'POST',
                    body: formData
                });

                if (!response.ok) {
                    throw new Error('Upload fallito');
                }

                const data = await response.json();
                transcriptionVideoFileId = data.file_id;

                // Show file info
                document.getElementById('transcriptionVideoName').textContent = data.filename;
                document.getElementById('transcriptionVideoInfo').style.display = 'block';

                // Show preview
                const uploadArea = document.getElementById('transcriptionVideoUpload');
                const uploadContent = uploadArea.querySelector('.upload-content');
                const previewOverlay = document.getElementById('transcriptionVideoPreviewOverlay');
                const video = previewOverlay.querySelector('video');

                uploadContent.style.display = 'none';
                video.src = data.path;
                video.load();
                previewOverlay.style.display = 'flex';

                // Enable transcription button
                document.getElementById('btn-start-transcription').disabled = false;

                console.log('‚úÖ Video caricato per trascrizione:', data);

            } catch (error) {
                console.error('Errore upload video:', error);
                alert('‚ùå Errore durante l\'upload del video: ' + error.message);
            }
        });

        function removeTranscriptionFile(event) {
            event.stopPropagation();
            event.preventDefault();

            transcriptionVideoFileId = null;

            const uploadArea = document.getElementById('transcriptionVideoUpload');
            const uploadContent = uploadArea.querySelector('.upload-content');
            const previewOverlay = document.getElementById('transcriptionVideoPreviewOverlay');
            const fileInfo = document.getElementById('transcriptionVideoInfo');

            uploadContent.style.display = 'flex';
            previewOverlay.style.display = 'none';
            fileInfo.style.display = 'none';

            document.getElementById('transcriptionVideoFile').value = '';
            document.getElementById('btn-start-transcription').disabled = true;

            console.log('üóëÔ∏è Video rimosso dalla trascrizione');
        }

        async function startTranscription() {
            if (!transcriptionVideoFileId) {
                alert('‚ö†Ô∏è Carica un video prima di avviare la trascrizione');
                return;
            }

            const progressDiv = document.getElementById('transcriptionProgress');
            const statusSpan = document.getElementById('transcriptionStatus');
            const progressBar = document.getElementById('transcriptionBar');
            const resultsDiv = document.getElementById('transcriptionResults');
            const btnStart = document.getElementById('btn-start-transcription');

            // Hide results and show progress
            resultsDiv.style.display = 'none';
            progressDiv.style.display = 'block';
            btnStart.disabled = true;

            statusSpan.textContent = 'Trascrizione in corso...';
            progressBar.style.width = '30%';

            try {
                const formData = new FormData();
                formData.append('file_id', transcriptionVideoFileId);

                const response = await fetch('/api/transcribe-video', {
                    method: 'POST',
                    body: formData
                });

                progressBar.style.width = '70%';

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.detail || 'Errore durante la trascrizione');
                }

                const data = await response.json();

                progressBar.style.width = '100%';
                statusSpan.textContent = 'Trascrizione completata!';

                // Wait a moment and show results
                setTimeout(() => {
                    progressDiv.style.display = 'none';
                    resultsDiv.style.display = 'block';

                    document.getElementById('srtFileName').textContent = data.srt_filename;
                    document.getElementById('txtFileName').textContent = data.txt_filename;

                    console.log('‚úÖ Trascrizione completata:', data);
                }, 500);

            } catch (error) {
                console.error('Errore trascrizione:', error);
                statusSpan.textContent = 'Errore: ' + error.message;
                progressBar.style.width = '0%';

                setTimeout(() => {
                    progressDiv.style.display = 'none';
                    btnStart.disabled = false;
                }, 3000);

                alert('‚ùå ' + error.message);
            }
        }

        function resetTranscription() {
            // Reset UI
            document.getElementById('transcriptionResults').style.display = 'none';
            document.getElementById('btn-start-transcription').disabled = false;

            // Clear file
            removeTranscriptionFile(new Event('click'));

            console.log('üîÑ Trascrizione resettata');
        }

        // File Manager Functions
        async function loadFilesManager() {
            try {
                const container = document.getElementById('filesManagerContainer');
                container.innerHTML = '<p style="text-align: center; padding: 40px; color: #6c757d;">Caricamento...</p>';

                const response = await fetch('/api/files');
                const data = await response.json();

                if (!data.files || data.files.length === 0) {
                    container.innerHTML = '<p style="text-align: center; padding: 40px; color: #6c757d;">Nessun file disponibile</p>';
                    return;
                }

                // Group files by type
                const recordings = data.files.filter(f => f.name.startsWith('recording_'));
                const outputs = data.files.filter(f => f.name.includes('_output'));
                const others = data.files.filter(f => !f.name.startsWith('recording_') && !f.name.includes('_output'));

                let html = '';

                // Registrazioni section
                if (recordings.length > 0) {
                    html += `
                        <div style="margin-bottom: 30px;">
                            <h3 style="color: #667eea; margin-bottom: 15px;"><i class="fas fa-record-vinyl"></i> Registrazioni (${recordings.length})</h3>
                            <div style="display: grid; gap: 15px;">
                    `;

                    for (const file of recordings) {
                        const sizeM = (file.size / 1024 / 1024).toFixed(1);
                        const date = new Date(file.modified * 1000).toLocaleString('it-IT');

                        html += `
                            <div style="background: white; padding: 20px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); display: flex; justify-content: space-between; align-items: center;">
                                <div>
                                    <h4 style="margin: 0 0 5px 0; color: #333;">üìπ ${file.name}</h4>
                                    <p style="margin: 0; font-size: 0.9rem; color: #6c757d;">${sizeM} MB | ${date}</p>
                                </div>
                                <div style="display: flex; gap: 10px;">
                                    <a href="${file.path}" download="${file.name}" class="btn-secondary" style="text-decoration: none;">
                                        <i class="fas fa-download"></i> Download
                                    </a>
                                    <button class="btn-danger" onclick="deleteFileManager('${file.name}')">
                                        <i class="fas fa-trash"></i> Elimina
                                    </button>
                                </div>
                            </div>
                        `;
                    }

                    html += `
                            </div>
                        </div>
                    `;
                }

                // Video Elaborati section
                if (outputs.length > 0) {
                    html += `
                        <div style="margin-bottom: 30px;">
                            <h3 style="color: #667eea; margin-bottom: 15px;"><i class="fas fa-video"></i> Video Elaborati (${outputs.length})</h3>
                            <div style="display: grid; gap: 15px;">
                    `;

                    for (const file of outputs) {
                        const sizeM = (file.size / 1024 / 1024).toFixed(1);
                        const date = new Date(file.modified * 1000).toLocaleString('it-IT');

                        html += `
                            <div style="background: white; padding: 20px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); display: flex; justify-content: space-between; align-items: center;">
                                <div>
                                    <h4 style="margin: 0 0 5px 0; color: #333;">üé¨ ${file.name}</h4>
                                    <p style="margin: 0; font-size: 0.9rem; color: #6c757d;">${sizeM} MB | ${date}</p>
                                </div>
                                <div style="display: flex; gap: 10px;">
                                    <a href="${file.path}" download="${file.name}" class="btn-secondary" style="text-decoration: none;">
                                        <i class="fas fa-download"></i> Download
                                    </a>
                                    <button class="btn-danger" onclick="deleteFileManager('${file.name}')">
                                        <i class="fas fa-trash"></i> Elimina
                                    </button>
                                </div>
                            </div>
                        `;
                    }

                    html += `
                            </div>
                        </div>
                    `;
                }

                // Altri File section
                if (others.length > 0) {
                    html += `
                        <div style="margin-bottom: 30px;">
                            <h3 style="color: #667eea; margin-bottom: 15px;"><i class="fas fa-file"></i> Altri File (${others.length})</h3>
                            <div style="display: grid; gap: 15px;">
                    `;

                    for (const file of others) {
                        const sizeM = (file.size / 1024 / 1024).toFixed(1);
                        const date = new Date(file.modified * 1000).toLocaleString('it-IT');

                        html += `
                            <div style="background: white; padding: 20px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); display: flex; justify-content: space-between; align-items: center;">
                                <div>
                                    <h4 style="margin: 0 0 5px 0; color: #333;">üìÑ ${file.name}</h4>
                                    <p style="margin: 0; font-size: 0.9rem; color: #6c757d;">${sizeM} MB | ${date}</p>
                                </div>
                                <div style="display: flex; gap: 10px;">
                                    <a href="${file.path}" download="${file.name}" class="btn-secondary" style="text-decoration: none;">
                                        <i class="fas fa-download"></i> Download
                                    </a>
                                    <button class="btn-danger" onclick="deleteFileManager('${file.name}')">
                                        <i class="fas fa-trash"></i> Elimina
                                    </button>
                                </div>
                            </div>
                        `;
                    }

                    html += `
                            </div>
                        </div>
                    `;
                }

                container.innerHTML = html;

            } catch (error) {
                console.error('Errore caricamento file:', error);
                document.getElementById('filesManagerContainer').innerHTML =
                    '<p style="text-align: center; padding: 40px; color: #dc2626;">‚ùå Errore caricamento file</p>';
            }
        }

        async function deleteFileManager(filename) {
            if (!confirm(`Eliminare "${filename}"?`)) {
                return;
            }

            try {
                const response = await fetch(`/api/delete/${encodeURIComponent(filename)}`, {
                    method: 'DELETE'
                });

                if (response.ok) {
                    alert('‚úÖ File eliminato!');
                    loadFilesManager();
                } else {
                    const error = await response.json();
                    alert('‚ùå Errore: ' + (error.detail || 'Eliminazione fallita'));
                }
            } catch (error) {
                console.error('Errore eliminazione:', error);
                alert('‚ùå Errore: ' + error.message);
            }
        }

        async function deleteAllFilesManager() {
            if (!confirm('‚ö†Ô∏è ATTENZIONE: Eliminare TUTTI i file?\nQuesta azione √® irreversibile!')) {
                return;
            }

            try {
                const response = await fetch('/api/delete-all-recordings', {
                    method: 'DELETE'
                });

                if (response.ok) {
                    const data = await response.json();
                    alert(`‚úÖ ${data.deleted} file eliminati!`);
                    loadFilesManager();
                } else {
                    const error = await response.json();
                    alert('‚ùå Errore: ' + (error.detail || 'Eliminazione fallita'));
                }
            } catch (error) {
                console.error('Errore eliminazione:', error);
                alert('‚ùå Errore: ' + error.message);
            }
        }

        // Wrap showTab to auto-load File Manager
        const originalShowTab = window.showTab;
        window.showTab = function(tabName) {
            // Call original tab switching
            originalShowTab(tabName);

            // Auto-load File Manager when switching to files tab
            if (tabName === 'files') {
                loadFilesManager();
            }
        };

        // ========== WEB VIDEO DOWNLOAD FUNCTIONS ==========

        let downloadedWebVideoData = null;

        async function downloadWebVideo() {
            const urlInput = document.getElementById('webVideoUrl');
            const url = urlInput.value.trim();

            if (!url) {
                alert('‚ö†Ô∏è Inserisci un URL valido');
                return;
            }

            // Valida URL base
            try {
                new URL(url);
            } catch {
                alert('‚ö†Ô∏è URL non valido. Inserisci un link completo (es: https://...)');
                return;
            }

            // Mostra progress
            const progressDiv = document.getElementById('webDownloadProgress');
            const statusSpan = document.getElementById('webDownloadStatus');
            const progressBar = document.getElementById('webDownloadBar');

            progressDiv.style.display = 'block';
            statusSpan.textContent = 'Download in corso...';
            progressBar.style.width = '30%';

            try {
                const formData = new FormData();
                formData.append('url', url);

                const response = await fetch('/api/download-web-video', {
                    method: 'POST',
                    body: formData
                });

                progressBar.style.width = '70%';

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.detail || 'Errore durante il download');
                }

                const data = await response.json();

                progressBar.style.width = '100%';
                statusSpan.textContent = 'Download completato! Caricamento nella sezione video principale...';

                // Salva dati per uso successivo
                downloadedWebVideoData = data;

                // Attendi mezzo secondo e poi mostra nel video principale
                setTimeout(() => {
                    progressDiv.style.display = 'none';

                    // Imposta automaticamente come video principale
                    setMainVideo(data);

                    // Pulisci campo URL
                    urlInput.value = '';

                    console.log('‚úÖ Video scaricato e caricato:', data);
                }, 500);

            } catch (error) {
                console.error('Errore download:', error);
                statusSpan.textContent = 'Errore: ' + error.message;
                progressBar.style.width = '0%';

                setTimeout(() => {
                    progressDiv.style.display = 'none';
                }, 3000);

                alert('‚ùå ' + error.message);
            }
        }

        function setMainVideo(videoData) {
            console.log('üîß setMainVideo chiamato con:', videoData);

            // IMPORTANTE: Imposta PRIMA le variabili globali (definite in modern-app.js)
            // NON usare window.* perch√© le variabili sono dichiarate con let, non window.
            backgroundFileId = videoData.file_id;
            backgroundFileName = videoData.filename;

            console.log('‚úÖ Variabili globali impostate:', {
                backgroundFileId: backgroundFileId,
                backgroundFileName: backgroundFileName
            });

            // Mostra nome file
            document.getElementById('mainVideoName').textContent = videoData.filename;
            const fileInfo = document.getElementById('mainVideoInfo');
            fileInfo.classList.add('active');
            fileInfo.style.display = 'block';

            // Nascondi area upload e mostra preview
            const uploadArea = document.getElementById('mainVideoUpload');
            const uploadContent = uploadArea.querySelector('.upload-content');
            const previewOverlay = document.getElementById('mainVideoPreviewOverlay');

            // Nascondi contenuto upload
            if (uploadContent) {
                uploadContent.style.display = 'none';
            }

            // Mostra overlay preview nella zona upload
            const overlayVideo = previewOverlay.querySelector('video');
            overlayVideo.src = videoData.path;
            overlayVideo.load();
            previewOverlay.style.display = 'flex';

            // Mostra anche preview sotto
            const mainPreview = document.getElementById('mainVideoPreview');
            const mainVideo = mainPreview.querySelector('video');
            mainVideo.src = videoData.path;
            mainVideo.load();
            mainPreview.style.display = 'block';
            mainPreview.style.opacity = '1';
            mainPreview.style.visibility = 'visible';

            // Mostra pulsante download
            const downloadBtn = document.getElementById('downloadMainVideoBtn');
            downloadBtn.style.display = 'inline-block';

            // Salva nel localStorage DOPO aver impostato le variabili globali
            // Usa setTimeout per assicurarsi che tutto sia aggiornato
            setTimeout(() => {
                try {
                    if (typeof saveSettings === 'function') {
                        saveSettings();
                        console.log('‚úÖ Settings salvato dopo download web video');
                    } else {
                        console.warn('‚ö†Ô∏è saveSettings non disponibile, salvo manualmente');
                        // Salva manualmente se saveSettings non √® disponibile
                        const settings = JSON.parse(localStorage.getItem('aiVideoMakerSettings') || '{}');
                        settings.backgroundFileId = videoData.file_id;
                        settings.backgroundFileName = videoData.filename;
                        localStorage.setItem('aiVideoMakerSettings', JSON.stringify(settings));
                        console.log('‚úÖ Settings salvato manualmente:', settings);
                    }
                } catch (error) {
                    console.error('‚ùå Errore salvataggio settings:', error);
                }
            }, 100);

            // Scroll alla sezione video principale
            setTimeout(() => {
                document.querySelector('.main-upload-card').scrollIntoView({ behavior: 'smooth', block: 'start' });
            }, 200);

            console.log('üìπ Video principale impostato:', videoData);
        }

        function downloadMainVideoToPC() {
            if (!downloadedWebVideoData) {
                alert('‚ö†Ô∏è Nessun video disponibile per il download');
                return;
            }

            // Crea link temporaneo per download
            const a = document.createElement('a');
            a.href = downloadedWebVideoData.path;
            a.download = downloadedWebVideoData.filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);

            console.log('üì• Download sul PC avviato:', downloadedWebVideoData.filename);
        }

        // Permetti invio con Enter nel campo URL
        document.getElementById('webVideoUrl')?.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                downloadWebVideo();
            }
        });

        // ============================================================================
        // CUSTOM MODAL SYSTEM - Alert e Conferme Personalizzate
        // ============================================================================

        let customAlertResolve = null;
        let customConfirmResolve = null;

        // Mapping icone per tipo alert
        const alertIcons = {
            'success': '‚úÖ',
            'error': '‚ùå',
            'warning': '‚ö†Ô∏è',
            'info': '‚ÑπÔ∏è'
        };

        // Mapping colori header per tipo alert
        const alertColors = {
            'success': 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)',
            'error': 'linear-gradient(135deg, #f093fb 0%, #f5576c 100%)',
            'warning': 'linear-gradient(135deg, #ffecd2 0%, #fcb69f 100%)',
            'info': 'linear-gradient(135deg, #a8edea 0%, #fed6e3 100%)'
        };

        // Mostra alert personalizzato (sostituisce window.alert)
        function showAlert(message, type = 'info') {
            return new Promise((resolve) => {
                customAlertResolve = resolve;

                const modal = document.getElementById('customAlertModal');
                const icon = document.getElementById('customAlertIcon');
                const title = document.getElementById('customAlertTitle');
                const messageEl = document.getElementById('customAlertMessage');
                const header = document.getElementById('customAlertHeader');

                // Imposta contenuto
                icon.textContent = alertIcons[type] || '‚ÑπÔ∏è';
                title.textContent = type === 'error' ? 'Errore' :
                                   type === 'warning' ? 'Attenzione' :
                                   type === 'success' ? 'Successo' : 'Informazione';
                messageEl.innerHTML = message;
                header.style.background = alertColors[type] || alertColors.info;
                header.style.color = type === 'warning' ? '#333' : 'white';

                // Mostra modal
                modal.style.display = 'flex';

                // Log console
                console.log(`[${type.toUpperCase()}] ${message}`);
            });
        }

        // Chiudi alert personalizzato
        function closeCustomAlert() {
            const modal = document.getElementById('customAlertModal');
            modal.style.display = 'none';
            if (customAlertResolve) {
                customAlertResolve();
                customAlertResolve = null;
            }
        }

        // Mostra conferma personalizzata (sostituisce window.confirm)
        function showConfirm(message, title = 'Conferma') {
            return new Promise((resolve) => {
                customConfirmResolve = resolve;

                const modal = document.getElementById('customConfirmModal');
                const titleEl = document.getElementById('customConfirmTitle');
                const messageEl = document.getElementById('customConfirmMessage');

                // Imposta contenuto
                titleEl.textContent = title;
                messageEl.innerHTML = message;

                // Mostra modal
                modal.style.display = 'flex';
            });
        }

        // Chiudi conferma personalizzata
        function closeCustomConfirm(result) {
            const modal = document.getElementById('customConfirmModal');
            modal.style.display = 'none';
            if (customConfirmResolve) {
                customConfirmResolve(result);
                customConfirmResolve = null;
            }
        }

        // ============================================================================
        // VIDEO TRANSLATION FUNCTIONS - Gestione traduzione video con AI
        // ============================================================================

        let currentTranslationJobId = null;
        let translationPollingInterval = null;
        let uploadedTranslationVideoData = null; // Dati video caricato

        // Mapping bandierine paesi per codici lingua
        const languageFlags = {
            'auto': 'üåç', // Rilevamento automatico
            'it': 'üáÆüáπ', // Italiano
            'en': 'üá¨üáß', // Inglese
            'es': 'üá™üá∏', // Spagnolo
            'fr': 'üá´üá∑', // Francese
            'de': 'üá©üá™', // Tedesco
            'pt': 'üáµüáπ', // Portoghese
            'ru': 'üá∑üá∫', // Russo
            'ja': 'üáØüáµ', // Giapponese
            'zh-CN': 'üá®üá≥', // Cinese
            'ar': 'üá∏üá¶', // Arabo
            'hi': 'üáÆüá≥'  // Hindi
        };

        // ============================================================================
        // UPLOAD VIDEO PER TRADUZIONE - Gestione upload diretto
        // ============================================================================

        // Setup upload area con drag & drop
        function setupTranslationVideoUpload() {
            const uploadArea = document.getElementById('translationVideoUploadArea');
            const fileInput = document.getElementById('translationVideoFile');

            // Drag & Drop
            uploadArea.addEventListener('dragover', (e) => {
                e.preventDefault();
                uploadArea.style.borderColor = '#667eea';
                uploadArea.style.background = 'rgba(102, 126, 234, 0.05)';
            });

            uploadArea.addEventListener('dragleave', () => {
                uploadArea.style.borderColor = '#e0e0e0';
                uploadArea.style.background = '';
            });

            uploadArea.addEventListener('drop', (e) => {
                e.preventDefault();
                uploadArea.style.borderColor = '#e0e0e0';
                uploadArea.style.background = '';

                const files = e.dataTransfer.files;
                if (files.length > 0) {
                    fileInput.files = files;
                    handleTranslationVideoUpload(files[0]);
                }
            });

            // File input change
            fileInput.addEventListener('change', (e) => {
                if (e.target.files.length > 0) {
                    handleTranslationVideoUpload(e.target.files[0]);
                }
            });
        }

        // Gestione upload video traduzione
        async function handleTranslationVideoUpload(file) {
            try {
                // Validazione tipo file
                if (!file.type.startsWith('video/')) {
                    showAlert('‚ö†Ô∏è Seleziona un file video valido', 'warning');
                    return;
                }

                // Validazione dimensione (500 MB)
                const maxSize = 500 * 1024 * 1024;
                if (file.size > maxSize) {
                    showAlert('‚ö†Ô∏è Il video √® troppo grande. Massimo 500 MB', 'error');
                    return;
                }

                // Mostra info file
                const videoInfo = document.getElementById('translationVideoInfo');
                const videoName = document.getElementById('translationVideoName');
                const videoSize = document.getElementById('translationVideoSize');

                videoName.textContent = file.name;
                videoSize.textContent = formatFileSize(file.size);
                videoInfo.style.display = 'block';

                // Upload al server
                showAlert('üì§ Caricamento video in corso...', 'info');

                const formData = new FormData();
                formData.append('file', file);

                const response = await fetch('/api/upload', {
                    method: 'POST',
                    body: formData
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.detail || 'Errore upload');
                }

                const data = await response.json();
                uploadedTranslationVideoData = data;

                // Mostra preview
                showTranslationVideoPreview(data.path);

                // Deseleziona select (se era selezionato)
                document.getElementById('translationVideoSelect').value = '';

                showAlert('‚úÖ Video caricato con successo!', 'success');

                console.log('‚úÖ Video caricato per traduzione:', data);

            } catch (error) {
                console.error('Errore upload video traduzione:', error);
                showAlert('‚ùå Errore caricamento: ' + error.message, 'error');
            }
        }

        // Mostra preview video caricato
        function showTranslationVideoPreview(videoPath) {
            const uploadArea = document.getElementById('translationVideoUploadArea');
            const uploadContent = uploadArea.querySelector('.upload-content');
            const previewOverlay = document.getElementById('translationVideoPreviewOverlay');
            const previewPlayer = document.getElementById('translationVideoPreviewPlayer');

            // Nascondi upload content, mostra preview
            uploadContent.style.display = 'none';
            previewOverlay.style.display = 'block';

            // Imposta video source
            previewPlayer.src = videoPath;
        }

        // Rimuovi video caricato
        async function removeTranslationVideo(event) {
            event.stopPropagation();

            const confirmed = await showConfirm('Vuoi rimuovere il video caricato?', 'Rimuovi Video');
            if (!confirmed) {
                return;
            }

            const uploadArea = document.getElementById('translationVideoUploadArea');
            const uploadContent = uploadArea.querySelector('.upload-content');
            const previewOverlay = document.getElementById('translationVideoPreviewOverlay');
            const previewPlayer = document.getElementById('translationVideoPreviewPlayer');
            const videoInfo = document.getElementById('translationVideoInfo');
            const fileInput = document.getElementById('translationVideoFile');

            // Reset UI
            uploadContent.style.display = 'flex';
            previewOverlay.style.display = 'none';
            previewPlayer.src = '';
            videoInfo.style.display = 'none';
            fileInput.value = '';

            // Reset data
            uploadedTranslationVideoData = null;

            console.log('‚úÖ Video traduzione rimosso');
        }

        // Helper: formatta dimensione file
        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return Math.round(bytes / Math.pow(k, i) * 100) / 100 + ' ' + sizes[i];
        }

        // ============================================================================
        // SALVATAGGIO AUTOMATICO IMPOSTAZIONI TRADUZIONE
        // ============================================================================

        const TRANSLATION_SETTINGS_KEY = 'translation_settings';

        // Default settings
        const defaultTranslationSettings = {
            sourceLanguage: 'auto',
            targetLanguage: ''
        };

        // Salva impostazioni traduzione
        function saveTranslationSettings() {
            const settings = {
                sourceLanguage: document.getElementById('sourceLanguage').value || 'auto',
                targetLanguage: document.getElementById('targetLanguage').value || ''
            };

            localStorage.setItem(TRANSLATION_SETTINGS_KEY, JSON.stringify(settings));
            console.log('üíæ Impostazioni traduzione salvate:', settings);
        }

        // Carica impostazioni traduzione
        function loadTranslationSettings() {
            try {
                const saved = localStorage.getItem(TRANSLATION_SETTINGS_KEY);
                if (saved) {
                    const settings = JSON.parse(saved);
                    console.log('üìÇ Impostazioni traduzione caricate:', settings);
                    return settings;
                }
            } catch (e) {
                console.error('Errore caricamento impostazioni traduzione:', e);
            }
            return defaultTranslationSettings;
        }

        // Ripristina impostazioni default traduzione
        function resetTranslationSettings() {
            console.log('üîÑ Ripristino impostazioni traduzione default');

            // Reset UI
            document.getElementById('sourceLanguage').value = 'auto';
            document.getElementById('targetLanguage').value = '';

            // Salva default
            localStorage.setItem(TRANSLATION_SETTINGS_KEY, JSON.stringify(defaultTranslationSettings));

            console.log('‚úÖ Impostazioni traduzione ripristinate');
        }

        // ============================================================================
        // LINGUE SUPPORTATE
        // ============================================================================

        // Carica lingue supportate all'avvio
        async function loadSupportedLanguages() {
            try {
                const response = await fetch('/api/translation/languages');
                const data = await response.json();

                if (data.success) {
                    const sourceSelect = document.getElementById('sourceLanguage');
                    const targetSelect = document.getElementById('targetLanguage');

                    // Popola select lingua sorgente
                    sourceSelect.innerHTML = '';

                    // Opzione "Rilevamento Automatico" come default
                    const autoOption = document.createElement('option');
                    autoOption.value = 'auto';
                    autoOption.textContent = `${languageFlags['auto']} Rilevamento Automatico`;
                    autoOption.selected = true;
                    sourceSelect.appendChild(autoOption);

                    // Separator
                    const separator = document.createElement('option');
                    separator.disabled = true;
                    separator.textContent = '‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ';
                    sourceSelect.appendChild(separator);

                    // Ordina lingue alfabeticamente
                    const sortedLangs = Object.entries(data.languages).sort((a, b) =>
                        a[1].localeCompare(b[1])
                    );

                    // Aggiungi lingue con bandierine a SOURCE select
                    sortedLangs.forEach(([code, name]) => {
                        const option = document.createElement('option');
                        option.value = code;
                        const flag = languageFlags[code] || 'üåê';
                        option.textContent = `${flag} ${name}`;
                        sourceSelect.appendChild(option);
                    });

                    // Popola select lingua target (senza "Rilevamento Automatico")
                    targetSelect.innerHTML = '<option value="">-- Seleziona lingua --</option>';

                    sortedLangs.forEach(([code, name]) => {
                        const option = document.createElement('option');
                        option.value = code;
                        const flag = languageFlags[code] || 'üåê';
                        option.textContent = `${flag} ${name}`;
                        targetSelect.appendChild(option);
                    });

                    console.log('‚úÖ Lingue supportate caricate:', Object.keys(data.languages).length);

                    // Carica e applica impostazioni salvate
                    const savedSettings = loadTranslationSettings();
                    sourceSelect.value = savedSettings.sourceLanguage || 'auto';
                    targetSelect.value = savedSettings.targetLanguage || '';

                    // Aggiungi event listener per salvataggio automatico
                    sourceSelect.addEventListener('change', saveTranslationSettings);
                    targetSelect.addEventListener('change', saveTranslationSettings);

                    console.log('‚úÖ Impostazioni traduzione applicate');
                }
            } catch (error) {
                console.error('Errore caricamento lingue:', error);
                showAlert('Errore caricamento lingue: ' + error.message, 'error');
            }
        }


        // Avvia traduzione video
        async function startVideoTranslation() {
            try {
                // Verifica che video sia stato caricato
                if (!uploadedTranslationVideoData) {
                    await showAlert('‚ö†Ô∏è Carica un video da tradurre', 'warning');
                    return;
                }

                const fileId = uploadedTranslationVideoData.file_id;

                // Validazione lingua
                const sourceLang = document.getElementById('sourceLanguage').value || 'auto';
                const targetLang = document.getElementById('targetLanguage').value;

                if (!targetLang) {
                    await showAlert('Seleziona una lingua di destinazione', 'warning');
                    return;
                }

                // Verifica che non stia traducendo nella stessa lingua
                if (sourceLang !== 'auto' && sourceLang === targetLang) {
                    await showAlert('La lingua sorgente e quella di destinazione non possono essere uguali!', 'warning');
                    return;
                }

                // Disabilita bottone
                const btn = document.getElementById('translateBtn');
                btn.disabled = true;
                btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Avvio...';

                // Nascondi risultati precedenti
                document.getElementById('translationResult').style.display = 'none';

                // Avvia traduzione
                const formData = new FormData();
                formData.append('file_id', fileId);
                formData.append('source_language', sourceLang);
                formData.append('target_language', targetLang);

                const response = await fetch('/api/translation/translate-video', {
                    method: 'POST',
                    body: formData
                });

                const data = await response.json();

                if (!response.ok) {
                    throw new Error(data.detail || 'Errore avvio traduzione');
                }

                // Salva job ID e avvia polling
                currentTranslationJobId = data.job_id;

                // Mostra progress
                document.getElementById('translationProgress').style.display = 'block';
                document.getElementById('translationPercentage').textContent = '0%';
                document.getElementById('translationProgressBar').style.width = '0%';
                document.getElementById('translationMessage').textContent = 'Inizializzazione traduzione...';

                // Avvia polling stato
                startTranslationPolling();

                console.log('‚úÖ Traduzione avviata, job ID:', currentTranslationJobId);

            } catch (error) {
                console.error('Errore avvio traduzione:', error);
                showAlert('Errore: ' + error.message, 'error');

                // Ripristina bottone
                const btn = document.getElementById('translateBtn');
                btn.disabled = false;
                btn.innerHTML = '<i class="fas fa-language"></i> Avvia Traduzione';
            }
        }

        // Polling stato traduzione
        function startTranslationPolling() {
            if (translationPollingInterval) {
                clearInterval(translationPollingInterval);
            }

            translationPollingInterval = setInterval(async () => {
                try {
                    const response = await fetch(`/api/jobs/${currentTranslationJobId}`);
                    const job = await response.json();

                    // Aggiorna UI
                    document.getElementById('translationPercentage').textContent = `${job.progress}%`;
                    document.getElementById('translationProgressBar').style.width = `${job.progress}%`;
                    document.getElementById('translationMessage').textContent = job.message;

                    // Controlla se completato
                    if (job.status === 'completed') {
                        clearInterval(translationPollingInterval);
                        onTranslationComplete(job);
                    } else if (job.status === 'error' || job.status === 'cancelled') {
                        clearInterval(translationPollingInterval);
                        onTranslationError(job);
                    }

                } catch (error) {
                    console.error('Errore polling traduzione:', error);
                }
            }, 2000); // Poll ogni 2 secondi
        }

        // Gestione completamento traduzione
        function onTranslationComplete(job) {
            console.log('‚úÖ Traduzione completata:', job);

            // Nascondi progress
            document.getElementById('translationProgress').style.display = 'none';

            // Mostra risultato
            const resultDiv = document.getElementById('translationResult');
            resultDiv.style.display = 'block';

            // Carica video tradotto nel player
            const player = document.getElementById('translatedVideoPlayer');
            player.src = job.output_file;

            // Ripristina bottone
            const btn = document.getElementById('translateBtn');
            btn.disabled = false;
            btn.innerHTML = '<i class="fas fa-language"></i> Avvia Traduzione';

            showAlert('‚úÖ Video tradotto con successo!', 'success');
        }

        // Gestione errore traduzione
        function onTranslationError(job) {
            console.error('‚ùå Errore traduzione:', job);

            // Nascondi progress
            document.getElementById('translationProgress').style.display = 'none';

            // Ripristina bottone
            const btn = document.getElementById('translateBtn');
            btn.disabled = false;
            btn.innerHTML = '<i class="fas fa-language"></i> Avvia Traduzione';

            showAlert(`Errore traduzione: ${job.error || job.message}`, 'error');
        }

        // Annulla traduzione
        async function cancelTranslation() {
            if (!currentTranslationJobId) return;

            try {
                const confirmed = await showConfirm(
                    'Vuoi davvero annullare la traduzione in corso? Il progresso sar√† perso.',
                    'Annulla Traduzione'
                );
                if (!confirmed) return;

                await fetch(`/api/jobs/${currentTranslationJobId}`, {
                    method: 'DELETE'
                });

                // Stop polling
                if (translationPollingInterval) {
                    clearInterval(translationPollingInterval);
                }

                // Nascondi progress
                document.getElementById('translationProgress').style.display = 'none';

                // Ripristina bottone
                const btn = document.getElementById('translateBtn');
                btn.disabled = false;
                btn.innerHTML = '<i class="fas fa-language"></i> Avvia Traduzione';

                currentTranslationJobId = null;

                showAlert('Traduzione annullata', 'info');

            } catch (error) {
                console.error('Errore annullamento:', error);
                showAlert('Errore annullamento traduzione: ' + error.message, 'error');
            }
        }

        // Download video tradotto
        async function downloadTranslatedVideo() {
            if (!currentTranslationJobId) {
                showAlert('Nessun video tradotto disponibile', 'warning');
                return;
            }

            try {
                window.location.href = `/api/translation/download/${currentTranslationJobId}`;
                showAlert('Download avviato!', 'success');
            } catch (error) {
                console.error('Errore download:', error);
                showAlert('Errore download: ' + error.message, 'error');
            }
        }

        // Reset interfaccia traduzione
        function resetTranslation() {
            // Nascondi risultati
            document.getElementById('translationResult').style.display = 'none';
            document.getElementById('translationProgress').style.display = 'none';

            // Reset upload area
            const uploadArea = document.getElementById('translationVideoUploadArea');
            const uploadContent = uploadArea.querySelector('.upload-content');
            const previewOverlay = document.getElementById('translationVideoPreviewOverlay');
            const previewPlayer = document.getElementById('translationVideoPreviewPlayer');
            const videoInfo = document.getElementById('translationVideoInfo');
            const fileInput = document.getElementById('translationVideoFile');

            uploadContent.style.display = 'flex';
            previewOverlay.style.display = 'none';
            previewPlayer.src = '';
            videoInfo.style.display = 'none';
            fileInput.value = '';

            // Reset selezioni
            document.getElementById('sourceLanguage').value = 'auto'; // Reset a rilevamento automatico
            document.getElementById('targetLanguage').value = '';

            // Reset data
            uploadedTranslationVideoData = null;
            currentTranslationJobId = null;

            if (translationPollingInterval) {
                clearInterval(translationPollingInterval);
            }

            console.log('‚úÖ Interfaccia traduzione resettata');
        }

        // Inizializzazione tab traduzione
        document.addEventListener('DOMContentLoaded', function() {
            // Setup upload area
            setupTranslationVideoUpload();

            // Carica lingue supportate
            loadSupportedLanguages();

            console.log('‚úÖ Tab Traduzione Video inizializzata');
        });

        // ============================================================================
        // GESTIONE IMPOSTAZIONI GLOBALI
        // ============================================================================

        /**
         * Ripristina tutte le impostazioni ai valori di default
         */
        async function resetSettings() {
            const confirmed = await showConfirm(
                'Sei sicuro di voler ripristinare tutte le impostazioni ai valori predefiniti? Questa operazione non pu√≤ essere annullata.',
                'üîÑ Ripristina Impostazioni'
            );

            if (!confirmed) {
                console.log('‚ùå Reset impostazioni annullato dall\'utente');
                return;
            }

            console.log('üîÑ Ripristino impostazioni globali...');

            // Reset impostazioni traduzione
            resetTranslationSettings();

            // Reset altre impostazioni (qualit√†, toggle, ecc.)
            // Qualit√† preset
            const qualityPreset = document.getElementById('qualityPreset');
            if (qualityPreset) {
                qualityPreset.value = 'balanced';
            }

            // Reset feature toggles
            const logoOverlay = document.getElementById('logoOverlay');
            if (logoOverlay) {
                logoOverlay.checked = false;
            }

            // Pulizia completa localStorage (opzionale - commentato per sicurezza)
            // localStorage.clear();

            console.log('‚úÖ Tutte le impostazioni ripristinate ai valori default');
            await showAlert('‚úÖ Impostazioni ripristinate con successo!', 'success');
        }

        /**
         * Esporta tutte le impostazioni come file JSON
         */
        function exportSettings() {
            console.log('üì§ Esportazione impostazioni...');

            try {
                // Raccolta di tutte le impostazioni
                const allSettings = {
                    version: '1.0',
                    exportDate: new Date().toISOString(),
                    translation: loadTranslationSettings(),
                    quality: {
                        preset: document.getElementById('qualityPreset')?.value || 'balanced'
                    },
                    features: {
                        logoOverlay: document.getElementById('logoOverlay')?.checked || false
                    }
                };

                // Crea file JSON
                const jsonString = JSON.stringify(allSettings, null, 2);
                const blob = new Blob([jsonString], { type: 'application/json' });
                const url = URL.createObjectURL(blob);

                // Download automatico
                const a = document.createElement('a');
                a.href = url;
                a.download = `aivideomaker_settings_${new Date().toISOString().split('T')[0]}.json`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);

                console.log('‚úÖ Impostazioni esportate:', allSettings);
                showAlert('‚úÖ Impostazioni esportate con successo!', 'success');
            } catch (error) {
                console.error('‚ùå Errore durante esportazione impostazioni:', error);
                showAlert('‚ùå Errore durante l\'esportazione delle impostazioni', 'error');
            }
        }

        /**
         * Importa impostazioni da file JSON
         */
        async function importSettings(event) {
            console.log('üì• Importazione impostazioni...');

            const file = event.target.files[0];
            if (!file) {
                console.log('‚ùå Nessun file selezionato');
                return;
            }

            try {
                const text = await file.text();
                const settings = JSON.parse(text);

                console.log('üìÇ Impostazioni importate:', settings);

                // Valida struttura
                if (!settings.version) {
                    throw new Error('File di impostazioni non valido');
                }

                // Conferma prima di applicare
                const confirmed = await showConfirm(
                    `Importare le impostazioni esportate il ${new Date(settings.exportDate).toLocaleDateString('it-IT')}? Le impostazioni correnti saranno sovrascritte.`,
                    'üì• Importa Impostazioni'
                );

                if (!confirmed) {
                    console.log('‚ùå Importazione annullata');
                    return;
                }

                // Applica impostazioni traduzione
                if (settings.translation) {
                    localStorage.setItem(TRANSLATION_SETTINGS_KEY, JSON.stringify(settings.translation));

                    // Applica immediatamente all'UI
                    const sourceSelect = document.getElementById('sourceLanguage');
                    const targetSelect = document.getElementById('targetLanguage');

                    if (sourceSelect && settings.translation.sourceLanguage) {
                        sourceSelect.value = settings.translation.sourceLanguage;
                    }
                    if (targetSelect && settings.translation.targetLanguage) {
                        targetSelect.value = settings.translation.targetLanguage;
                    }
                }

                // Applica impostazioni qualit√†
                if (settings.quality && settings.quality.preset) {
                    const qualityPreset = document.getElementById('qualityPreset');
                    if (qualityPreset) {
                        qualityPreset.value = settings.quality.preset;
                    }
                }

                // Applica feature toggles
                if (settings.features) {
                    const logoOverlay = document.getElementById('logoOverlay');
                    if (logoOverlay && settings.features.logoOverlay !== undefined) {
                        logoOverlay.checked = settings.features.logoOverlay;
                    }
                }

                console.log('‚úÖ Impostazioni importate e applicate con successo');
                await showAlert('‚úÖ Impostazioni importate con successo!', 'success');

                // Reset input file
                event.target.value = '';

            } catch (error) {
                console.error('‚ùå Errore durante importazione impostazioni:', error);
                await showAlert('‚ùå Errore durante l\'importazione: file non valido o corrotto', 'error');
                event.target.value = '';
            }
        }

    </script>
</body>
</html>